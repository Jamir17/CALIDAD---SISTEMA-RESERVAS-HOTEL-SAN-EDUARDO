{% extends "base.html" %}
{% block title %}Registro - Hotel San Eduardo{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/registro.css') }}">
<style>
  /* ----- Estado desactivado ----- */
  #btnRegistrar[disabled],
  .disabled-btn {
    background-color: #9ca3af !important;
    color: #ffffff !important;
    cursor: not-allowed !important;
    opacity: 0.8 !important;
    transition: background-color .3s ease, opacity .3s ease;
  }

  /* ----- Estado activado ----- */
  .enabled-btn {
    background-color: #1d4ed8 !important;
    color: #ffffff !important;
    cursor: pointer !important;
    opacity: 1 !important;
    transition: background-color .3s ease, opacity .3s ease;
  }
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
{% endblock %}

{% block content %}
<div class="auth-page">
  <div class="auth-container">
    <div class="auth-header">
      <h1>Crear cuenta</h1>
      <p>√önete a Hotel San Eduardo y disfruta de beneficios exclusivos</p>
    </div>

    <!-- Flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ category }}">{{ message }}</div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    <!-- FORMULARIO -->
    <form id="frmRegistro" method="POST" action="{{ url_for('usuarios.registro') }}">
      <div class="form-row">
        <div class="form-group">
          <label for="nombre">Nombre</label>
          <input id="nombre" name="nombre" class="form-input" required>
        </div>
        <div class="form-group">
          <label for="apellido">Apellido</label>
          <input id="apellido" name="apellido" class="form-input" required>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="tipo_documento">Tipo de documento</label>
          <select id="tipo_documento" name="tipo_documento" class="form-input" required>
            <option value="DNI" selected>DNI</option>
            <option value="Pasaporte">Pasaporte</option>
            <option value="CE">Carn√© de Extranjer√≠a</option>
          </select>
        </div>
        <div class="form-group">
          <label for="num_documento">N¬∞ de documento</label>
          <input id="num_documento" name="num_documento" class="form-input" required>
        </div>
      </div>

      <div class="form-group">
        <label for="email">Correo electr√≥nico</label>
        <input type="email" id="email" name="correo" class="form-input" required>
      </div>

      <div class="form-group">
        <label for="nacionalidad">Nacionalidad</label>
        <select id="nacionalidad" name="nacionalidad" class="form-input" required></select>
      </div>

      <div class="form-group">
        <label for="direccion">Direcci√≥n</label>
        <input id="direccion" name="direccion" class="form-input">
      </div>

      <div class="form-group">
        <label>Tel√©fono</label>
        <div class="form-row" style="gap:12px;">
          <select id="codigo_pais" name="codigo_pais" class="form-input" style="max-width:180px" required></select>
          <input id="telefono" name="telefono" class="form-input" required>
        </div>
      </div>

      <div class="form-group">
        <label for="password">Contrase√±a</label>
        <div class="password-wrapper">
          <input type="password" id="password" name="password" class="form-input" minlength="8" required>
          <span class="toggle-password" onclick="togglePasswordVisibility('password', this)">
            <i class="fas fa-eye"></i>
          </span>
        </div>
      </div>

      <div class="form-group">
        <label for="confirm_password">Confirmar contrase√±a</label>
        <div class="password-wrapper">
          <input type="password" id="confirm_password" name="confirm_password" class="form-input" required>
          <span class="toggle-password" onclick="togglePasswordVisibility('confirm_password', this)">
            <i class="fas fa-eye"></i>
          </span>
        </div>
      </div>


      <div class="checkbox-group">
        <input type="checkbox" id="terms" name="terms">
        <label for="terms">
          He le√≠do y acepto los
          <a href="#" id="btnAbrirTerminos">t√©rminos y condiciones</a> y la
          <a href="#" id="btnAbrirPrivacidad">pol√≠tica de privacidad</a>.
        </label>
      </div>

      <div class="form-actions">
        <button type="submit" id="btnRegistrar" class="btn btn-primary disabled-btn" disabled>Crear cuenta</button>
      </div>
    </form>
  </div>
</div>

<!-- ===== MODALES ===== -->
<div class="modal-overlay" id="modalTerminos">
  <div class="modal-content">
    <h2>T√©rminos y Condiciones</h2>
    <p>Al crear una cuenta en Hotel San Eduardo, usted acepta las pol√≠ticas internas del establecimiento y el uso
      responsable del sistema.</p>
    <div class="modal-footer">
      <button class="btn-cerrar" data-close="modalTerminos">Cerrar</button>
      <button class="btn-aceptar" id="btnAceptarTerminos">Aceptar</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modalPrivacidad">
  <div class="modal-content">
    <h2>Pol√≠tica de Privacidad</h2>
    <p>Hotel San Eduardo protege sus datos conforme a la Ley N¬∞ 29733. Sus datos se usan solo para reservas y
      comunicaciones.</p>
    <div class="modal-footer">
      <button class="btn-cerrar" data-close="modalPrivacidad">Cerrar</button>
      <button class="btn-aceptar" id="btnAceptarPrivacidad">Aceptar</button>
    </div>
  </div>
</div>

<!-- ===== SCRIPT ===== -->
<script>
  /* ==========================================
     üîß L√ìGICA ROBUSTA, COMPLETA Y FUNCIONAL
     ========================================== */

  function togglePasswordVisibility(idDelCampo, elementoToggle) {
    const passwordInput = document.getElementById(idDelCampo);
    // Seleccionamos el icono <i> dentro del span
    const icon = elementoToggle.querySelector('i');

    if (!passwordInput) return; // Salir si el input no existe

    if (passwordInput.type === "password") {
      passwordInput.type = "text";

      // Muestra el icono de "Ojo Tachado" (Ocultar)
      icon.classList.remove("fa-eye");
      icon.classList.add("fa-eye-slash");
    } else {
      passwordInput.type = "password";

      // Muestra el icono de "Ojo Abierto" (Mostrar)
      icon.classList.remove("fa-eye-slash");
      icon.classList.add("fa-eye");
    }
  }


  // function togglePasswordVisibility(idDelCampo, elementoToggle) {
  //   const passwordInput = document.getElementById(idDelCampo);
  //   // Seleccionamos el icono <i> dentro del span
  //   const icon = elementoToggle.querySelector('i');

  //   if (!passwordInput) return; // Salir si el input no existe

  //   if (passwordInput.type === "password") {
  //     passwordInput.type = "text";

  //     // Muestra el icono de "Ojo Tachado" (Ocultar)
  //     icon.classList.remove("fa-eye");
  //     icon.classList.add("fa-eye-slash");
  //   } else {
  //     passwordInput.type = "password";

  //     // Muestra el icono de "Ojo Abierto" (Mostrar)
  //     icon.classList.remove("fa-eye-slash");
  //     icon.classList.add("fa-eye");
  //   }
  // }

  // ====== VARIABLES BASE ======
  const body = document.body;
  const MODALS = ["modalTerminos", "modalPrivacidad"];
  const chkTerms = document.getElementById("terms");
  const btnSubmit = document.getElementById("btnRegistrar");
  const tipo = document.getElementById("tipo_documento");
  const num = document.getElementById("num_documento");

  // ====== MODALES (abrir / cerrar correctamente) ======
  function openModal(id) {
    closeAllModals();
    const el = document.getElementById(id);
    el.classList.add("open");
    el.setAttribute("aria-hidden", "false");
    body.classList.add("modal-open");
  }
  function closeModal(id) {
    const el = document.getElementById(id);
    if (!el) return;
    el.classList.remove("open");
    el.setAttribute("aria-hidden", "true");
    const anyOpen = MODALS.some(mid => document.getElementById(mid).classList.contains("open"));
    if (!anyOpen) body.classList.remove("modal-open");
  }
  function closeAllModals() {
    MODALS.forEach(id => {
      const el = document.getElementById(id);
      el.classList.remove("open");
      el.setAttribute("aria-hidden", "true");
    });
    body.classList.remove("modal-open");
  }

  // Cerrar con clic en fondo o ESC
  MODALS.forEach(id => {
    const overlay = document.getElementById(id);
    overlay.addEventListener("click", e => { if (e.target === overlay) closeModal(id); });
  });
  document.addEventListener("keydown", e => { if (e.key === "Escape") closeAllModals(); });

  // Cerrar con bot√≥n data-close (ya lo ten√≠as, lo restauro)
  document.addEventListener("click", e => {
    const btn = e.target.closest("[data-close]");
    if (btn) closeModal(btn.getAttribute("data-close"));
  });

  // ====== ABRIR MODALES DESDE LOS ENLACES ======
  document.getElementById("btnAbrirTerminos").addEventListener("click", e => {
    e.preventDefault(); e.stopPropagation();
    openModal("modalTerminos");
  });
  document.getElementById("btnAbrirPrivacidad").addEventListener("click", e => {
    e.preventDefault(); e.stopPropagation();
    openModal("modalPrivacidad");
  });

  // ====== ACEPTAR T√âRMINOS Y PRIVACIDAD ======
  let terminosAceptados = false;
  let privacidadAceptada = false;

  document.getElementById("btnAceptarTerminos").addEventListener("click", () => {
    terminosAceptados = true;
    closeModal("modalTerminos");
    openModal("modalPrivacidad");
  });
  document.getElementById("btnAceptarPrivacidad").addEventListener("click", () => {
    privacidadAceptada = true;
    closeModal("modalPrivacidad");
    chkTerms.checked = true;
    actualizarBoton();
  });

  // ====== CAMBIOS EN EL CHECKBOX ======
  chkTerms.addEventListener("change", () => {
    if (!chkTerms.checked) {
      terminosAceptados = false;
      privacidadAceptada = false;
    }
    actualizarBoton();
  });

  // ====== BOT√ìN HABILITADO / DESHABILITADO ======
  function actualizarBoton() {
    const ok = chkTerms.checked && terminosAceptados && privacidadAceptada;
    if (ok) {
      btnSubmit.disabled = false;
      btnSubmit.classList.remove("disabled-btn");
      btnSubmit.classList.add("enabled-btn");
    } else {
      btnSubmit.disabled = true;
      btnSubmit.classList.add("disabled-btn");
      btnSubmit.classList.remove("enabled-btn");
    }
  }

  // Estado inicial
  window.addEventListener("DOMContentLoaded", () => {
    btnSubmit.disabled = true;
    btnSubmit.classList.add("disabled-btn");
  });

  // ====== VALIDACI√ìN DE DOCUMENTOS ======
  function configurarDocumento() {
    const tipoDoc = tipo.value;
    if (tipoDoc === "DNI") {
      num.maxLength = 8;
      num.pattern = "\\d{8}";
      num.placeholder = "8 d√≠gitos (DNI)";
      num.title = "DNI: exactamente 8 d√≠gitos num√©ricos";
      num.value = num.value.replace(/\D/g, "").slice(0, 8);
    } else if (tipoDoc === "CE") {
      num.maxLength = 9;
      num.pattern = "[A-Za-z0-9]{6,9}";
      num.placeholder = "6‚Äì9 alfanum√©rico (CE)";
      num.title = "Carn√© de extranjer√≠a: 6 a 9 caracteres alfanum√©ricos";
      num.value = num.value.toUpperCase().replace(/[^A-Z0-9]/g, "").slice(0, 9);
    } else if (tipoDoc === "Pasaporte") {
      num.maxLength = 12;
      num.pattern = "[A-Za-z0-9]{6,12}";
      num.placeholder = "6‚Äì12 alfanum√©rico (Pasaporte)";
      num.title = "Pasaporte: 6 a 12 caracteres alfanum√©ricos";
      num.value = num.value.toUpperCase().replace(/[^A-Z0-9]/g, "").slice(0, 12);
    }
    validarNumero();
  }

  function validarNumero() {
    const tipoDoc = tipo.value;
    const val = num.value.trim();
    let valido = true;
    let msg = "";

    if (tipoDoc === "DNI" && !/^\d{8}$/.test(val)) {
      valido = false; msg = "El DNI debe tener exactamente 8 d√≠gitos.";
    } else if (tipoDoc === "CE" && !/^[A-Za-z0-9]{6,9}$/.test(val)) {
      valido = false; msg = "El CE debe tener entre 6 y 9 caracteres alfanum√©ricos.";
    } else if (tipoDoc === "Pasaporte" && !/^[A-Za-z0-9]{6,12}$/.test(val)) {
      valido = false; msg = "El Pasaporte debe tener entre 6 y 12 caracteres alfanum√©ricos.";
    }

    num.setCustomValidity(valido ? "" : msg);
  }

  tipo.addEventListener("change", configurarDocumento);
  num.addEventListener("input", () => {
    configurarDocumento();
    validarNumero();
  });
  configurarDocumento(); // inicializaci√≥n al cargar

  // ====== TEL√âFONO ======
  const tel = document.getElementById("telefono");
  tel.addEventListener("input", () => {
    tel.value = tel.value.replace(/[^0-9]/g, "").slice(0, 15);
  });

  // ====== CONTRASE√ëAS ======
  const pass = document.getElementById("password");
  const cpass = document.getElementById("confirm_password");

  function validarPasswords() {
    if (cpass.value !== pass.value) {
      cpass.setCustomValidity("Las contrase√±as no coinciden.");
    } else {
      cpass.setCustomValidity("");
    }
  }
  pass.addEventListener("input", validarPasswords);
  cpass.addEventListener("input", validarPasswords);

  // ====== NACIONALIDADES Y C√ìDIGOS DE TEL√âFONO ======
  const NACIONALIDADES = ["Per√∫", "Argentina", "Bolivia", "Brasil", "Chile", "Colombia", "Ecuador", "M√©xico", "Uruguay", "Venezuela", "Espa√±a", "Estados Unidos"];
  const PHONE_CODES = { "Per√∫": "51", "Argentina": "54", "Bolivia": "591", "Brasil": "55", "Chile": "56", "Colombia": "57", "Ecuador": "593", "M√©xico": "52", "Uruguay": "598", "Venezuela": "58", "Espa√±a": "34", "Estados Unidos": "1" };
  const selNac = document.getElementById("nacionalidad");
  const selCod = document.getElementById("codigo_pais");

  (function cargarNacionalidades() {
    selNac.innerHTML = "";
    const def = new Option("Selecciona tu nacionalidad", "", true, true);
    def.disabled = true;
    selNac.add(def);
    NACIONALIDADES.forEach(n => selNac.add(new Option(n, n)));
    selNac.value = "Per√∫";
  })();
  (function cargarCodigos() {
    selCod.innerHTML = "";
    const def = new Option("Per√∫ (+51)", "51", true, true);
    selCod.add(def);
    Object.entries(PHONE_CODES).forEach(([pais, code]) => {
      if (!(pais === "Per√∫" && code === "51")) {
        selCod.add(new Option(`${pais} (+${code})`, code));
      }
    });
  })();
  selNac.addEventListener("change", () => {
    const pais = selNac.value;
    if (PHONE_CODES[pais]) selCod.value = PHONE_CODES[pais];
  });

  // ====== SUBMIT FINAL ======
  const form = document.getElementById("frmRegistro");
  form.addEventListener("submit", e => {
    actualizarBoton();
    validarPasswords();
    validarNumero();

    if (btnSubmit.disabled) {
      e.preventDefault();
      alert("Debe aceptar los T√©rminos y la Pol√≠tica de Privacidad.");
      return;
    }
    if (!form.reportValidity()) {
      e.preventDefault();
      return;
    }
    btnSubmit.disabled = true;
    btnSubmit.textContent = "Enviando...";
  });
</script>

{% endblock %}