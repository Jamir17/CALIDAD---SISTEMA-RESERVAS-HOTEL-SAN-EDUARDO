{% extends "base.html" %}
{% block title %}Registro - Hotel San Eduardo{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/registro.css') }}">
<style>
/* ==============================
   üé® ESTILOS DE MODALES & FIXES
   ============================== */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 2000;
}
.modal-overlay.open { display: flex; }

.modal-content {
  background: #fff;
  border-radius: 8px;
  padding: 24px;
  width: 90%;
  max-width: 640px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.25);
  animation: fadeIn 0.25s ease;
}
@keyframes fadeIn {
  from { transform: translateY(-8px); opacity: 0; }
  to   { transform: translateY(0); opacity: 1; }
}
.modal-footer {
  display: flex;
  justify-content: flex-end;
  gap: 8px;
  margin-top: 16px;
}
.modal-footer button {
  padding: 8px 16px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}
.btn-aceptar { background-color: #2ecc71; color: #fff; }
.btn-cerrar  { background-color: #e74c3c; color: #fff; }
body.modal-open { overflow: hidden; }

/* Bot√≥n desactivado */
#btnRegistrar[disabled],
.disabled-btn {
  background-color: #9ca3af !important;
  color: #ffffff !important;
  cursor: not-allowed !important;
  opacity: 0.8 !important;
  transition: background-color 0.2s ease, opacity 0.2s ease;
}

/* Bot√≥n activado */
.enabled-btn {
  background-color: #1d4ed8 !important;
  color: #ffffff !important;
  cursor: pointer !important;
  opacity: 1 !important;
  transition: background-color 0.2s ease, opacity 0.2s ease;
}
</style>
{% endblock %}

{% block content %}
<div class="auth-page">
  <div class="auth-container">
    <div class="auth-header">
      <h1>Crear cuenta</h1>
      <p>√önete a Hotel San Eduardo y disfruta de beneficios exclusivos</p>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <form id="frmRegistro" method="POST" action="{{ url_for('usuarios.registro') }}" novalidate>
      <div class="form-row">
        <div class="form-group">
          <label for="nombre">Nombre</label>
          <input type="text" id="nombre" name="nombre" class="form-input" required>
        </div>
        <div class="form-group">
          <label for="apellido">Apellido</label>
          <input type="text" id="apellido" name="apellido" class="form-input" required>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="tipo_documento">Tipo de documento</label>
          <select id="tipo_documento" name="tipo_documento" class="form-input" required>
            <option value="DNI" selected>DNI</option>
            <option value="Pasaporte">Pasaporte</option>
            <option value="CE">Carn√© de Extranjer√≠a</option>
          </select>
        </div>
        <div class="form-group">
          <label for="num_documento">N¬∞ de documento</label>
          <input type="text" id="num_documento" name="num_documento" class="form-input" required>
        </div>
      </div>

      <div class="form-group">
        <label for="email">Correo electr√≥nico</label>
        <input type="email" id="email" name="email" class="form-input" required>
      </div>

      <div class="form-group">
        <label for="nacionalidad">Nacionalidad</label>
        <select id="nacionalidad" name="nacionalidad" class="form-input" required></select>
      </div>

      <div class="form-group">
        <label for="direccion">Direcci√≥n</label>
        <input type="text" id="direccion" name="direccion" class="form-input">
      </div>

      <div class="form-group">
        <label>Tel√©fono</label>
        <div class="form-row" style="gap:12px;">
          <select id="codigo_pais" name="codigo_pais" class="form-input" style="max-width:180px" required></select>
          <input type="tel" id="telefono" name="telefono" class="form-input" required>
        </div>
      </div>

      <div class="form-group">
        <label for="password">Contrase√±a</label>
        <input type="password" id="password" name="password" class="form-input" minlength="8" required>
      </div>
      <div class="form-group">
        <label for="confirm_password">Confirmar contrase√±a</label>
        <input type="password" id="confirm_password" name="confirm_password" class="form-input" required>
      </div>

      <div class="checkbox-group">
        <input type="checkbox" id="terms" name="terms">
        <label for="terms">
          He le√≠do y acepto los 
          <a href="#" id="btnAbrirTerminos">t√©rminos y condiciones</a> y la 
          <a href="#" id="btnAbrirPrivacidad">pol√≠tica de privacidad</a>.
        </label>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn btn-primary disabled-btn" id="btnRegistrar" disabled>Crear cuenta</button>
      </div>
    </form>
  </div>
</div>

<!-- ==============================
     üßæ MODAL T√âRMINOS
     ============================== -->
<div class="modal-overlay" id="modalTerminos">
  <div class="modal-content">
    <h2>T√©rminos y Condiciones</h2>
    <p>Al crear una cuenta en Hotel San Eduardo, usted acepta nuestras pol√≠ticas de uso responsable, reserva y cancelaci√≥n.</p>
    <div class="modal-footer">
      <button class="btn-cerrar" data-close="modalTerminos">Cerrar</button>
      <button class="btn-aceptar" id="btnAceptarTerminos">Aceptar</button>
    </div>
  </div>
</div>

<!-- ==============================
     üîí MODAL PRIVACIDAD
     ============================== -->
<div class="modal-overlay" id="modalPrivacidad">
  <div class="modal-content">
    <h2>Pol√≠tica de Privacidad</h2>
    <p>Hotel San Eduardo protege sus datos conforme a la Ley N¬∞ 29733. Sus datos se usan solo para fines de registro y reservas.</p>
    <div class="modal-footer">
      <button class="btn-cerrar" data-close="modalPrivacidad">Cerrar</button>
      <button class="btn-aceptar" id="btnAceptarPrivacidad">Aceptar</button>
    </div>
  </div>
</div>

<!-- ==============================
     üß† SCRIPTS (CORREGIDOS)
     ============================== -->
<script>
/* ---------- Utilidades modales ---------- */
const body = document.body;
const modalIds = ["modalTerminos","modalPrivacidad"];
function closeAllModals(){
  modalIds.forEach(id=>{
    const el=document.getElementById(id);
    el.classList.remove("open");
  });
  body.classList.remove("modal-open");
}
function openModal(id){
  closeAllModals();
  document.getElementById(id).classList.add("open");
  body.classList.add("modal-open");
}
function closeModal(id){
  document.getElementById(id).classList.remove("open");
  const anyOpen = modalIds.some(mid=>document.getElementById(mid).classList.contains("open"));
  if(!anyOpen) body.classList.remove("modal-open");
}
modalIds.forEach(id=>{
  const overlay=document.getElementById(id);
  overlay.addEventListener("click",e=>{if(e.target===overlay)closeModal(id);});
});
document.addEventListener("keydown",e=>{if(e.key==="Escape")closeAllModals();});

/* ---------- Documentos ---------- */
const tipo=document.getElementById("tipo_documento");
const num=document.getElementById("num_documento");
function validarDocumento(){
  const tipoDoc=tipo.value;
  num.value=(num.value||"").toUpperCase();
  if(tipoDoc==="DNI"){
    num.value=num.value.replace(/\D/g,"").slice(0,8);
  }
}
tipo.addEventListener("change",validarDocumento);
num.addEventListener("input",validarDocumento);

/* ---------- Nacionalidad y tel√©fono ---------- */
const NACIONALIDADES=["Per√∫","Argentina","Bolivia","Brasil","Chile","Colombia","Ecuador","M√©xico","Uruguay","Venezuela","Espa√±a","Estados Unidos"];
const PHONE_CODES={"Per√∫":"51","Argentina":"54","Bolivia":"591","Brasil":"55","Chile":"56","Colombia":"57","Ecuador":"593","M√©xico":"52","Uruguay":"598","Venezuela":"58","Espa√±a":"34","Estados Unidos":"1"};
const selNac=document.getElementById("nacionalidad");
const selCod=document.getElementById("codigo_pais");
(function cargarDatos(){
  selNac.innerHTML="<option disabled selected>Selecciona tu nacionalidad</option>";
  NACIONALIDADES.forEach(n=>selNac.add(new Option(n,n)));
  selCod.innerHTML="";
  Object.entries(PHONE_CODES).forEach(([pais,code])=>{
    selCod.add(new Option(`${pais} (+${code})`,code,pais==="Per√∫"));
  });
})();

/* ---------- T√©rminos & Privacidad ---------- */
let terminosAceptados=false;
let privacidadAceptada=false;
const chk=document.getElementById("terms");
const btn=document.getElementById("btnRegistrar");

// bot√≥n inicia gris
window.addEventListener("DOMContentLoaded",()=>{
  btn.disabled=true;
  btn.classList.add("disabled-btn");
  btn.classList.remove("enabled-btn");
});

// abrir modales
document.getElementById("btnAbrirTerminos").addEventListener("click",e=>{
  e.preventDefault();openModal("modalTerminos");
});
document.getElementById("btnAbrirPrivacidad").addEventListener("click",e=>{
  e.preventDefault();openModal("modalPrivacidad");
});

// aceptar modales
document.getElementById("btnAceptarTerminos").addEventListener("click",()=>{
  terminosAceptados=true;
  closeModal("modalTerminos");
  openModal("modalPrivacidad");
});
document.getElementById("btnAceptarPrivacidad").addEventListener("click",()=>{
  privacidadAceptada=true;
  closeModal("modalPrivacidad");
  chk.checked=true;
  actualizarBoton();
});

// check manual
chk.addEventListener("change",()=>{
  if(!chk.checked){terminosAceptados=false;privacidadAceptada=false;}
  actualizarBoton();
});

// actualizar estado visual
function actualizarBoton(){
  const ok=chk.checked&&terminosAceptados&&privacidadAceptada;
  if(ok){
    btn.disabled=false;
    btn.classList.remove("disabled-btn");
    btn.classList.add("enabled-btn");
  }else{
    btn.disabled=true;
    btn.classList.add("disabled-btn");
    btn.classList.remove("enabled-btn");
  }
}

/* ---------- Validaci√≥n de env√≠o ---------- */
const form=document.getElementById("frmRegistro");
form.addEventListener("submit",e=>{
  actualizarBoton();
  if(btn.disabled){
    e.preventDefault();
    alert("Debe aceptar los T√©rminos y la Pol√≠tica de Privacidad para continuar.");
    return;
  }
  btn.disabled=true;
  btn.textContent="Enviando...";
});
</script>
{% endblock %}
