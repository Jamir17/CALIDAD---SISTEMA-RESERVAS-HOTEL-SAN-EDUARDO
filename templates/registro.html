{% extends "base.html" %}
{% block title %}Registro - Hotel San Eduardo{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/registro.css') }}">
<style>
/* ==============================
   üé® ESTILOS DE MODALES
   ============================== */
.modal-overlay {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.5);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 2000;
}
.modal-content {
  background: #fff;
  border-radius: 8px;
  padding: 25px;
  width: 90%;
  max-width: 600px;
  box-shadow: 0 3px 10px rgba(0,0,0,0.25);
  animation: fadeIn 0.3s ease;
}
@keyframes fadeIn {
  from { transform: translateY(-10px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}
.modal-content h2 {
  margin-top: 0;
  color: #2c3e50;
}
.modal-footer {
  text-align: right;
  margin-top: 20px;
}
.modal-footer button {
  padding: 8px 16px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}
.btn-aceptar {
  background-color: #2ecc71;
  color: white;
}
.btn-cerrar {
  background-color: #e74c3c;
  color: white;
  margin-right: 8px;
}

/* Estado desactivado */
.disabled-btn {
  background-color: #9ca3af !important; /* gris */
  cursor: not-allowed !important;
  opacity: 0.8 !important;
}

/* Estado activado (normal) */
.enabled-btn {
  background-color: #1d4ed8 !important; /* azul */
  cursor: pointer !important;
  opacity: 1 !important;
}
</style>
{% endblock %}

{% block content %}
<div class="auth-page">
  <div class="auth-container">
    <div class="auth-header">
      <h1>Crear cuenta</h1>
      <p>√önete a Hotel San Eduardo y disfruta de beneficios exclusivos</p>
    </div>

    <!-- Mensajes flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <!-- FORMULARIO DE REGISTRO -->
    <form id="frmRegistro" method="POST" action="{{ url_for('usuarios.registro') }}">

      <!-- Nombre y Apellido -->
      <div class="form-row">
        <div class="form-group">
          <label class="form-label" for="nombre">Nombre</label>
          <input type="text" id="nombre" name="nombre" class="form-input" placeholder="Juan" required>
        </div>

        <div class="form-group">
          <label class="form-label" for="apellido">Apellido</label>
          <input type="text" id="apellido" name="apellido" class="form-input" placeholder="P√©rez" required>
        </div>
      </div>

      <!-- Tipo y N¬∞ de Documento -->
      <div class="form-row">
        <div class="form-group">
          <label class="form-label" for="tipo_documento">Tipo de documento</label>
          <select id="tipo_documento" name="tipo_documento" class="form-input" required>
            <option value="DNI" selected>DNI</option>
            <option value="Pasaporte">Pasaporte</option>
            <option value="CE">Carn√© de Extranjer√≠a</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label" for="num_documento">N¬∞ de documento</label>
          <input type="text" id="num_documento" name="num_documento" class="form-input" required>
        </div>
      </div>

      <!-- Correo -->
      <div class="form-group">
        <label class="form-label" for="email">Correo electr√≥nico</label>
        <input type="email" id="email" name="correo" class="form-input" placeholder="ejemplo@correo.com" required>
      </div>

      <!-- Nacionalidad -->
      <div class="form-group">
        <label class="form-label" for="nacionalidad">Nacionalidad</label>
        <select id="nacionalidad" name="nacionalidad" class="form-input" required></select>
      </div>

      <!-- Direcci√≥n -->
      <div class="form-group">
        <label class="form-label" for="direccion">Direcci√≥n</label>
        <input type="text" id="direccion" name="direccion" class="form-input" placeholder="Calle, n√∫mero, ciudad">
      </div>

      <!-- Tel√©fono -->
      <div class="form-group">
        <label class="form-label">Tel√©fono</label>
        <div class="form-row" style="gap:12px; align-items:center;">
          <select id="codigo_pais" name="codigo_pais" class="form-input" style="max-width:160px" required></select>
          <input type="tel" id="telefono" name="telefono" class="form-input" placeholder="999 999 999" required>
        </div>
        <small class="muted">Formato internacional (E.164): +51XXXXXXXXX</small>
      </div>

      <!-- Contrase√±a -->
      <div class="form-group">
        <label class="form-label" for="password">Contrase√±a</label>
        <input type="password" id="password" name="password" class="form-input" minlength="8" required placeholder="M√≠nimo 8 caracteres">
      </div>

      <div class="form-group">
        <label class="form-label" for="confirm_password">Confirmar contrase√±a</label>
        <input type="password" id="confirm_password" name="confirm_password" class="form-input" required placeholder="Repite tu contrase√±a">
      </div>

      <!-- Checkbox de t√©rminos -->
      <div class="checkbox-group" style="margin-top: 20px;">
        <input type="checkbox" id="terms" name="terms">
        <label for="terms">
          He le√≠do y acepto los 
          <a href="#" id="linkTerminos">t√©rminos y condiciones</a> 
          y la 
          <a href="#" id="linkPrivacidad">pol√≠tica de privacidad</a>.
        </label>
      </div>

      <!-- Bot√≥n inicialmente desactivado -->
      <div class="form-actions">
        <button type="submit" id="btnCrearCuenta" class="btn btn-primary disabled-btn" disabled>Crear cuenta</button>
      </div>
    </form>
  </div>
</div>

<!-- ==============================
     üßæ MODAL T√âRMINOS
     ============================== -->
<div class="modal-overlay" id="modalTerminos">
  <div class="modal-content">
    <h2>T√©rminos y condiciones</h2>
    <p>
      Al registrarse en Hotel San Eduardo, el usuario acepta cumplir con las normas de conducta del establecimiento,
      el uso responsable de los servicios, y las pol√≠ticas de cancelaci√≥n y reservas.
      El incumplimiento de las mismas puede derivar en la suspensi√≥n de los beneficios de cliente.
    </p>
    <div class="modal-footer">
      <button class="btn-cerrar" onclick="cerrarModal('modalTerminos')">Cerrar</button>
      <button class="btn-aceptar" onclick="aceptarTerminos()">Aceptar</button>
    </div>
  </div>
</div>

<!-- ==============================
     üîí MODAL PRIVACIDAD
     ============================== -->
<div class="modal-overlay" id="modalPrivacidad">
  <div class="modal-content">
    <h2>Pol√≠tica de privacidad</h2>
    <p>
      Hotel San Eduardo garantiza la confidencialidad de los datos personales seg√∫n la Ley N¬∞ 29733.
      La informaci√≥n proporcionada ser√° utilizada √∫nicamente para fines de registro, comunicaci√≥n y servicios hoteleros.
      El usuario podr√° solicitar la eliminaci√≥n o modificaci√≥n de sus datos en cualquier momento.
    </p>
    <div class="modal-footer">
      <button class="btn-cerrar" onclick="cerrarModal('modalPrivacidad')">Cerrar</button>
      <button class="btn-aceptar" onclick="aceptarPrivacidad()">Aceptar</button>
    </div>
  </div>
</div>

<!-- ==============================
     üß† SCRIPTS
     ============================== -->
<script>
  const check = document.getElementById('terms');
  const btn = document.getElementById('btnCrearCuenta');

  // Iniciar con bot√≥n desactivado visualmente
  btn.classList.add('disabled-btn');

  check.addEventListener('change', () => {
    if (check.checked) {
      btn.disabled = false;
      btn.classList.remove('disabled-btn');
      btn.classList.add('enabled-btn');
    } else {
      btn.disabled = true;
      btn.classList.remove('enabled-btn');
      btn.classList.add('disabled-btn');
    }
  });
</script>

<script>
// ===== VALIDACI√ìN DE DOCUMENTOS =====
const tipo = document.getElementById("tipo_documento");
const num = document.getElementById("num_documento");

function validarDocumento() {
  const tipoDoc = tipo.value;
  num.value = num.value.toUpperCase();

  if (tipoDoc === "DNI") {
    num.value = num.value.replace(/\D/g, '').slice(0, 8);
    num.maxLength = 8;
    num.pattern = "\\d{8}";
    num.title = "Debe contener exactamente 8 d√≠gitos.";
  } else if (tipoDoc === "Pasaporte") {
    num.maxLength = 12;
    num.pattern = "[A-Za-z0-9]{6,12}";
    num.title = "6 a 12 caracteres alfanum√©ricos.";
  } else if (tipoDoc === "CE") {
    num.maxLength = 9;
    num.pattern = "[A-Za-z0-9]{6,9}";
    num.title = "6 a 9 caracteres alfanum√©ricos.";
  }
}
tipo.addEventListener("change", validarDocumento);
num.addEventListener("input", validarDocumento);
validarDocumento();

// ===== MODALES =====
let terminosAceptados = false;
let privacidadAceptada = false;

document.getElementById("btnAbrirTerminos").addEventListener("click", (e) => {
  e.preventDefault();
  abrirModal("modalTerminos");
});
document.getElementById("btnAbrirPrivacidad").addEventListener("click", (e) => {
  e.preventDefault();
  abrirModal("modalPrivacidad");
});

function abrirModal(id) {
  document.body.style.overflow = "hidden";
  document.getElementById(id).style.display = "flex";
}
function cerrarModal(id) {
  document.body.style.overflow = "auto";
  document.getElementById(id).style.display = "none";
}
function aceptarTerminos() {
  terminosAceptados = true;
  cerrarModal("modalTerminos");
  abrirModal("modalPrivacidad");
}
function aceptarPrivacidad() {
  privacidadAceptada = true;
  cerrarModal("modalPrivacidad");
  document.getElementById("terms").checked = true;
  document.getElementById("btnRegistrar").disabled = false;
}

// ===== VALIDACI√ìN ANTES DE ENVIAR =====
document.getElementById("frmRegistro").addEventListener("submit", function (e) {
  if (!terminosAceptados || !privacidadAceptada) {
    e.preventDefault();
    alert("Debe aceptar los t√©rminos y la pol√≠tica de privacidad para continuar.");
  } else if (!this.reportValidity()) {
    e.preventDefault();
  }
});
</script>

<!-- ==============================
     üåé NACIONALIDADES Y TEL√âFONOS
     ============================== -->
<script>
const NACIONALIDADES = ["Per√∫","Argentina","Bolivia","Brasil","Chile","Colombia","Ecuador","M√©xico","Uruguay","Venezuela","Espa√±a","Estados Unidos"];
const PHONE_CODES = {"Per√∫":"51","Argentina":"54","Bolivia":"591","Brasil":"55","Chile":"56","Colombia":"57","Ecuador":"593","M√©xico":"52","Uruguay":"598","Venezuela":"58","Espa√±a":"34","Estados Unidos":"1"};

const selNac = document.getElementById("nacionalidad");
const selCod = document.getElementById("codigo_pais");

// Cargar nacionalidades
(function cargarNacionalidades() {
  const empty = new Option("Selecciona tu nacionalidad", "", true, true);
  empty.disabled = true;
  selNac.add(empty);
  NACIONALIDADES.forEach(n => selNac.add(new Option(n, n)));
  selNac.value = "Per√∫";
})();

// Cargar prefijos
(function buildCodes() {
  selCod.innerHTML = "";
  const def = new Option("Per√∫ (+51)", "51", true, true);
  selCod.add(def);
  Object.entries(PHONE_CODES).forEach(([pais, code]) => {
    if (!(pais === "Per√∫" && code === "51")) {
      selCod.add(new Option(`${pais} (+${code})`, code));
    }
  });
})();

// Sincronizar
selNac.addEventListener("change", () => {
  const pais = selNac.value;
  if (PHONE_CODES[pais]) selCod.value = PHONE_CODES[pais];
});
</script>

{% endblock %}
