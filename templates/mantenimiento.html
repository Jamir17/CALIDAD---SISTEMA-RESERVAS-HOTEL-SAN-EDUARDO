{% extends "principal.html" %}

{% block title %}Panel de Mantenimiento{% endblock %}

{% block extra_css %}
<style>
    .maintenance-container {
        padding: 20px;
        background-color: #f9fafb;
    }
    .maintenance-header h1 {
        font-size: 2rem;
        font-weight: 700;
        color: #111827;
    }
    .maintenance-header p { color: #6b7280; }
    .tabs-nav .nav-link {
        border: none;
        border-bottom: 2px solid transparent;
        color: #6b7280;
        font-weight: 500;
    }
    .tabs-nav .nav-link.active {
        color: #3b82f6;
        border-bottom-color: #3b82f6;
    }
    .stat-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }
    .stat-card-m {
        background-color: white;
        border-radius: 0.5rem;
        padding: 1.5rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .stat-card-m .stat-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    .stat-card-m h3 {
        font-size: 0.875rem;
        font-weight: 500;
        color: #6b7280;
    }
    .stat-card-m .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #111827;
    }
    .stat-card-m .stat-footer {
        font-size: 0.75rem;
        margin-top: 0.5rem;
    }
    .card-m {
        background-color: white;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        margin-bottom: 1.5rem;
    }
    .card-m-header {
        padding: 1.5rem;
        border-bottom: 1px solid #e5e7eb;
    }
    .card-m-header h2 {
        font-size: 1.25rem;
        font-weight: 700;
        color: #111827;
        margin: 0;
    }
    .card-m-header p {
        font-size: 0.875rem;
        color: #6b7280;
        margin-top: 0.25rem;
    }
    .card-m-body { padding: 1.5rem; }
    .task-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem;
        background-color: #f9fafb;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
    }
    .task-item h3 { font-size: 1rem; font-weight: 600; margin: 0; }
    .task-item p { font-size: 0.875rem; color: #6b7280; margin: 0.25rem 0 0; }
    .task-item .task-meta { font-size: 0.75rem; color: #6b7280; margin-top: 0.5rem; }
    .btn-start-task {
        background-color: #16a34a; /* Verde */
        color: white;
        border: none;
        padding: 0.6rem 1.2rem;
        border-radius: 0.375rem;
        font-weight: 500;
        cursor: pointer;
    }
    .progress-bar-container {
        width: 100%;
        background-color: #e5e7eb;
        border-radius: 9999px;
        height: 0.5rem;
    }
    .progress-bar {
        height: 0.5rem;
        border-radius: 9999px;
    }
    .alert-card {
        display: flex;
        align-items: flex-start;
        padding: 0.75rem;
        border-radius: 0.5rem;
        margin-bottom: 0.75rem;
    }
    .alert-card.warning { background-color: #fef3c7; }
    .alert-card.info { background-color: #dbeafe; }
    .alert-card .alert-icon { margin-right: 0.75rem; flex-shrink: 0; }
    .alert-card .alert-title { font-weight: 600; color: #92400e; }
    .alert-card.info .alert-title { color: #1e40af; }
    .alert-card .alert-text { font-size: 0.875rem; }
    .text-success { color: #15803d !important; }
    .text-warning { color: #b45309 !important; }
    .text-danger { color: #b91c1c !important; }

    /* Estilos para la Consola SQL */
    .sql-console-container { padding: 1.5rem; }
    .sql-console-container textarea {
        width: 100%;
        height: 150px;
        font-family: 'Courier New', Courier, monospace;
        font-size: 1rem;
        padding: 10px;
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
        background-color: #212529;
        color: #f8f9fa;
        resize: vertical;
    }
    .sql-result-container {
        margin-top: 1.5rem;
        padding: 1rem;
        background-color: #f8f9fa;
        border-radius: 0.375rem;
        min-height: 100px;
        max-height: 400px;
        overflow: auto;
    }
    .sql-result-container .table {
        margin-bottom: 0;
    }
    .sql-result-container .alert {
        margin-bottom: 0;
    }
    .btn-execute-sql {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }
CREATE TABLE contenido_dinamico (
    id INT AUTO_INCREMENT PRIMARY KEY,
    clave VARCHAR(50) NOT NULL UNIQUE,
    titulo VARCHAR(255),
    contenido TEXT,
    ultima_modificacion DATETIME NOT NULL
);
    .content-editor-container { padding: 1.5rem; }
    .content-editor-container textarea {
        height: 250px;
        font-family: sans-serif;
    }
</style>
{% endblock %}

{% block content %}
<div class="maintenance-container">
    <div class="maintenance-header">
        <h1>Panel de Mantenimiento</h1>
        <p>Gesti√≥n y monitoreo del sistema del hotel.</p>
    </div>

    <!-- Pesta√±as de Navegaci√≥n -->
    <ul class="nav tabs-nav" id="maintenanceTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">Visi√≥n general</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tasks-tab" data-bs-toggle="tab" data-bs-target="#tasks" type="button" role="tab">Tareas programadas</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="health-tab" data-bs-toggle="tab" data-bs-target="#health" type="button" role="tab">Salud del sistema</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="console-tab" data-bs-toggle="tab" data-bs-target="#console" type="button" role="tab">Consola Interactiva</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="editor-tab" data-bs-toggle="tab" data-bs-target="#editor" type="button" role="tab">Editor de Anuncios</button>
        </li>
    </ul>

    <!-- Contenido de las Pesta√±as -->
    <div class="tab-content" id="maintenanceTabsContent">
        <!-- Visi√≥n General -->
        <div class="tab-pane fade show active" id="overview" role="tabpanel">
        <div class="stat-grid">
            <div class="stat-card-m">
            <div class="stat-header"><h3>Tiempo de Actividad</h3></div>
            <div id="uptimeValue" class="stat-value">‚Äî</div>
            <div id="uptimeStatus" class="stat-footer text-success">Cargando...</div>
            </div>
            <div class="stat-card-m">
            <div class="stat-header"><h3>Uso de Memoria</h3></div>
            <div id="memValue" class="stat-value">‚Äî</div>
            <div id="memStatus" class="stat-footer text-muted">Cargando...</div>
            </div>
            <div class="stat-card-m">
            <div class="stat-header"><h3>Uso de CPU</h3></div>
            <div id="cpuValue" class="stat-value">‚Äî</div>
            <div id="cpuStatus" class="stat-footer text-muted">Cargando...</div>
            </div>
            <div class="stat-card-m">
            <div class="stat-header"><h3>√öltimo Respaldo</h3></div>
            <div class="stat-value" style="font-size: 1.1rem;">{{ ultimo_respaldo }}</div>
            <div class="stat-footer text-success">Reciente</div>
            </div>
        </div>

        <!-- üîπ Informaci√≥n din√°mica del servidor -->
        <div class="card-m mt-4">
            <div class="card-m-header">
            <h2>Informaci√≥n del Servidor</h2>
            <p>Detalles del equipo donde se ejecuta el sistema.</p>
            </div>
            <div class="card-m-body">
            <ul class="list-group list-group-flush" id="serverInfo">
                <li class="list-group-item"><b>Equipo:</b> ‚Äî</li>
                <li class="list-group-item"><b>Sistema Operativo:</b> ‚Äî</li>
                <li class="list-group-item"><b>Arquitectura:</b> ‚Äî</li>
                <li class="list-group-item"><b>Procesador:</b> ‚Äî</li>
                <li class="list-group-item"><b>Tiempo activo:</b> ‚Äî</li>
            </ul>
            </div>
        </div>

        <!-- Alertas din√°micas -->
        {% include '_alertas_mantenimiento.html' %}

        <div class="card-m">
            <div class="card-m-header">
            <h2>Registro de mantenimiento</h2>
            <p>Historial de actividades de mantenimiento.</p>
            </div>
            <div class="card-m-body">
            <table class="table table-hover">
                <thead>
                <tr>
                    <th>Fecha y Hora</th><th>Acci√≥n</th><th>Habitaci√≥n</th>
                    <th>Cliente</th><th>Nuevo Estado</th><th>Acciones</th>
                </tr>
                </thead>
                <tbody>
                {% for act in actividades %}
                <tr>
                    <td>{{ act.fecha_hora.strftime('%d/%m/%Y %H:%M') }}</td>
                    <td>
                    {% if act.accion == 'Check-in' %}<span class="badge bg-info text-dark">Check-in</span>
                    {% elif act.accion == 'Check-out' %}<span class="badge bg-warning text-dark">Check-out</span>
                    {% elif act.accion == 'Limpieza OK' %}<span class="badge bg-success">Limpieza</span>
                    {% else %}{{ act.accion }}{% endif %}
                    </td>
                    <td>{{ act.habitacion_numero or 'N/A' }}</td>
                    <td>{{ act.cliente_nombres or 'Sistema' }}</td>
                    <td>{{ act.nuevo_estado_hab }}</td>
                    <td>
                    <a href="{{ url_for('mantenimiento.detalle_log', id_actividad=act.id_actividad) }}" class="btn btn-sm btn-outline-primary">Ver detalles</a>
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="6" class="text-center">No hay actividades recientes.</td></tr>
                {% endfor %}
                </tbody>
            </table>
            </div>
        </div>
        </div>

        <!-- Tareas Programadas -->
        <div class="tab-pane fade" id="tasks" role="tabpanel">
            <div class="card-m">
                <div class="card-m-header">
                    <h2>Tareas programadas</h2>
                    <p>Lista de tareas de mantenimiento recurrentes.</p>
                </div>
                <div class="card-m-body">
                    <div class="task-item">
                        <div>
                            <h3>Actualizaciones de seguridad</h3>
                            <p>Aplicar parches y actualizaciones de dependencias.</p>
                            <div class="task-meta">Frecuencia: Semanal | Pr√≥ximo: 2025-11-27</div>
                        </div>
                        <button class="btn-start-task" onclick="runTask('updates')">Iniciar</button>
                    </div>
                    <div class="task-item">
                        <div>
                            <h3>Optimizaci√≥n de base de datos</h3>
                            <p>Reindexaci√≥n, limpieza y optimizaci√≥n de consultas.</p>
                            <div class="task-meta">Frecuencia: Mensual | Pr√≥ximo: 2025-12-05</div>
                        </div>
                        <button class="btn-start-task" onclick="runTask('db_optimization')">Iniciar</button>
                    </div>
                    <div class="task-item">
                        <div>
                            <h3>Respaldo de datos</h3>
                            <p>Creaci√≥n de copias de seguridad completas del sistema.</p>
                            <div class="task-meta">Frecuencia: Diario | Pr√≥ximo: 2025-11-21</div>
                        </div>
                        <button class="btn-start-task" onclick="runTask('backup')">Iniciar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Salud del Sistema -->
        <div class="tab-pane fade" id="health" role="tabpanel">
            <div class="card-m">
                <div class="card-m-header">
                    <h2>Salud del sistema</h2>
                    <p>Monitoreo en tiempo real del estado del sistema.</p>
                </div>
                <div class="card-m-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Indicadores clave</h5>
                            <div class="mb-3">
                                <div class="d-flex justify-content-between"><span>Uso de memoria</span><span>{{ "%.1f"|format(system_health.mem) }}%</span></div>
                                <div class="progress-bar-container"><div class="progress-bar bg-primary" style="width: {{ system_health.mem }}%;"></div></div>
                            </div>
                            <div class="mb-3">
                                <div class="d-flex justify-content-between"><span>Uso de CPU</span><span>{{ "%.1f"|format(system_health.cpu) }}%</span></div>
                                <div class="progress-bar-container"><div class="progress-bar bg-success" style="width: {{ system_health.cpu }}%;"></div></div>
                            </div>
                            <div class="mb-3">
                                <div class="d-flex justify-content-between"><span>Base de datos</span><span>{{ "%.2f"|format(system_health.db_size) }} MB</span></div>
                                <div class="progress-bar-container"><div class="progress-bar bg-info" style="width: {{ (system_health.db_size / 1024) * 100 }}%;"></div></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h5>Alertas</h5>
                             {% if system_health.mem > 80 %}
                            <div class="alert-card warning" id="alerta-memoria">
                                <div class="alert-icon">‚ö†Ô∏è</div>
                                <div>
                                    <div class="alert-title">Advertencia</div>
                                    <div class="alert-text">El uso de memoria es alto ({{ "%.1f"|format(system_health.mem) }}%). Considere reiniciar servicios.</div>
                                </div>
                            </div>
                            {% endif %}
                            <div class="alert-card info">
                                <div class="alert-icon">‚ÑπÔ∏è</div>
                                <div>
                                    <div class="alert-title">Informaci√≥n</div>
                                    <div class="alert-text">Todos los servicios est√°n funcionando normalmente.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Consola Interactiva -->
        <div class="tab-pane fade" id="console" role="tabpanel">
            <div class="card-m">
                <div class="card-m-header">
                    <h2>Consola SQL</h2>
                    <p>Ejecuta consultas SQL directamente en la base de datos. √ösalo con precauci√≥n.</p>
                </div>
                <div class="sql-console-container">
                    <form id="sqlForm">
                        <div class="mb-3">
                            <label for="sqlQuery" class="form-label fw-bold">Consulta SQL:</label>
                            <textarea id="sqlQuery" name="query" placeholder="SELECT * FROM usuarios LIMIT 10;"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary btn-execute-sql">Ejecutar</button>
                    </form>
                    <div id="sqlResult" class="sql-result-container">
                        <p class="text-muted">Los resultados aparecer√°n aqu√≠.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Editor de Contenido -->
        <div class="tab-pane fade" id="editor" role="tabpanel">
            <div class="card-m">
                <div class="card-m-header">
                    <h2>Editor de Anuncios de la P√°gina Principal</h2>
                    <p>Crea o modifica el anuncio que se muestra en la p√°gina de inicio. Puedes usar HTML b√°sico.</p>
                </div>
                <div class="content-editor-container">
                    <form id="contentForm">
                        <div class="mb-3">
                            <label for="contentTitle" class="form-label fw-bold">T√≠tulo del Anuncio:</label>
                            <input type="text" class="form-control" id="contentTitle" placeholder="Ej: Cierre de Piscina por Mantenimiento">
                        </div>
                        <div class="mb-3">
                            <label for="contentBody" class="form-label fw-bold">Contenido del Anuncio (HTML permitido):</label>
                            <textarea class="form-control" id="contentBody" placeholder="Ej: <p>Estimados hu√©spedes, les informamos que la <b>piscina</b> estar√° cerrada el d√≠a <b>lunes 24</b> por mantenimiento. Disculpen las molestias.</p>"></textarea>
                        </div>
                        <button type="submit" class="btn btn-success">Guardar Anuncio</button>
                    </form>
                    <div id="contentSaveResult" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Cargar contenido del editor cuando se muestra la pesta√±a
    const editorTab = document.getElementById('editor-tab');
    if (editorTab) {
        editorTab.addEventListener('show.bs.tab', loadContentForEditor);
    }
});

document.getElementById('sqlForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const query = document.getElementById('sqlQuery').value;
    const resultContainer = document.getElementById('sqlResult');
    resultContainer.innerHTML = '<p class="text-info">Ejecutando...</p>';

    try {
        const response = await fetch("{{ url_for('mantenimiento.ejecutar_sql') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ query: query })
        });
        const data = await response.json();
        renderSqlResult(data);
    } catch (error) {
        renderSqlResult({ ok: false, error: 'Error de red al conectar con el servidor.' });
    }
});

function renderSqlResult(data) {
    const container = document.getElementById('sqlResult');
    if (!data.ok) {
        container.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
        return;
    }

    if (data.message) {
        container.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
    } else if (data.result) {
        if (data.result.length === 0) {
            container.innerHTML = '<p class="text-muted">La consulta no devolvi√≥ resultados.</p>';
            return;
        }
        const headers = data.columns;
        let tableHtml = '<table class="table table-bordered table-striped table-sm"><thead><tr>';
        headers.forEach(h => tableHtml += `<th>${h}</th>`);
        tableHtml += '</tr></thead><tbody>';

        data.result.forEach(row => {
            tableHtml += '<tr>';
            headers.forEach(h => {
                const value = row[h] === null ? '<em>NULL</em>' : (row[h] === '' ? '<em>(vac√≠o)</em>' : row[h]);
                tableHtml += `<td>${value}</td>`;
            });
            tableHtml += '</tr>';
        });

        tableHtml += '</tbody></table>';
        container.innerHTML = tableHtml;
    }
}

async function loadContentForEditor() {
    const resultContainer = document.getElementById('contentSaveResult');
    try {
        const response = await fetch("{{ url_for('mantenimiento.obtener_contenido', clave='aviso_principal') }}");
        const data = await response.json();
        if (data.ok) {
            document.getElementById('contentTitle').value = data.data.titulo || '';
            document.getElementById('contentBody').value = data.data.contenido || '';
            resultContainer.innerHTML = '';
        } else {
            resultContainer.innerHTML = `<div class="alert alert-warning">${data.error}</div>`;
        }
    } catch (error) {
        resultContainer.innerHTML = `<div class="alert alert-danger">Error de red al cargar el contenido.</div>`;
    }
}

document.getElementById('contentForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const titulo = document.getElementById('contentTitle').value;
    const contenido = document.getElementById('contentBody').value;
    const resultContainer = document.getElementById('contentSaveResult');
    resultContainer.innerHTML = '<p class="text-info">Guardando...</p>';

    try {
        const response = await fetch("{{ url_for('mantenimiento.guardar_contenido', clave='aviso_principal') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ titulo: titulo, contenido: contenido })
        });
        const data = await response.json();
        if (data.ok) {
            resultContainer.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
        } else {
            resultContainer.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
        }
    } catch (error) {
        resultContainer.innerHTML = `<div class="alert alert-danger">Error de red al guardar el contenido.</div>`;
    }
});

function runTask(taskName) {
    let url = '';
    let successMessage = '';

    switch(taskName) {
        case 'backup':
            url = "{{ url_for('mantenimiento.ejecutar_respaldo_mantenimiento') }}";
            successMessage = '‚úÖ Respaldo de la base de datos iniciado con √©xito.';
            break;
        case 'updates':
            url = "{{ url_for('mantenimiento.ejecutar_actualizaciones') }}";
            successMessage = '‚úÖ Tarea de actualizaci√≥n de seguridad completada.';
            break;
        case 'db_optimization':
            // Simulaci√≥n
            alert('‚úÖ Tarea de optimizaci√≥n de base de datos simulada y completada.');
            return;
        default:
            alert('Tarea desconocida.');
            return;
    }

    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token if csrf_token else "" }}' // Para protecci√≥n CSRF si la usas
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.ok) {
            alert(successMessage);
        } else {
            alert('‚ùå Error: ' + data.message);
        }
        console.log('Respuesta del servidor:', data.log || data.message); // Log para depuraci√≥n
    })
    .catch(error => alert('‚ùå Error de red al ejecutar la tarea.'));
}

// =============================
// üîÑ Actualizaci√≥n din√°mica del panel
// =============================
async function actualizarSaludSistema() {
  try {
    const response = await fetch("{{ url_for('mantenimiento.api_salud_sistema') }}");
    const data = await response.json();

    if (!data.ok) return;

    // Actualiza CPU y memoria
    document.getElementById("cpuValue").textContent = `${data.cpu}%`;
    document.getElementById("memValue").textContent = `${data.mem}%`;

    // Cambia colores seg√∫n estado
    const cpuStatus = document.getElementById("cpuStatus");
    const memStatus = document.getElementById("memStatus");
    if (data.cpu > 80) cpuStatus.textContent = "Alto uso";
    else if (data.cpu > 60) cpuStatus.textContent = "Moderado";
    else cpuStatus.textContent = "Normal";

    if (data.mem > 80) memStatus.textContent = "Alto";
    else if (data.mem > 60) memStatus.textContent = "Normal";
    else memStatus.textContent = "√ìptimo";

    // Actualiza informaci√≥n del servidor
    const eq = data.equipo;
    const info = `
      <li class="list-group-item"><b>Equipo:</b> ${eq.nombre_equipo}</li>
      <li class="list-group-item"><b>Sistema Operativo:</b> ${eq.so} ${eq.version_so}</li>
      <li class="list-group-item"><b>Arquitectura:</b> ${eq.arquitectura}</li>
      <li class="list-group-item"><b>Procesador:</b> ${eq.procesador}</li>
      <li class="list-group-item"><b>Tiempo activo:</b> ${eq.uptime}</li>
    `;
    document.getElementById("serverInfo").innerHTML = info;

    // Tiempo de actividad global
    document.getElementById("uptimeValue").textContent = eq.uptime;
    document.getElementById("uptimeStatus").textContent = "Estable";
  } catch (err) {
    console.error("Error al actualizar estado del sistema:", err);
  }
}

// Ejecutar cada 5 segundos
setInterval(actualizarSaludSistema, 5000);
actualizarSaludSistema();

</script>
{% endblock %}