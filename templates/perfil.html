{% extends "base.html" %}
{% block title %}Mi Perfil - Hotel San Eduardo{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/perfil.css') }}">
{% endblock %}

{% block content %}
<section class="profile-section">
  <div class="container">
    <h1 class="page-title">Mi perfil</h1>
    <p class="page-sub">Gestiona tu información personal y preferencias</p>

    <!-- Mensajes Flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          {% if category == 'success' %}
            <div id="successMessage" data-message="{{ message }}"></div>
          {% else %}
            <div class="alert alert-{{ category }}">{{ message }}</div>
          {% endif %}
        {% endfor %}
      {% endif %}
    {% endwith %}

    <div class="grid">
      <!-- Columna Izquierda -->
      <div>
        <section class="card">
          <div class="avatar">
            <div class="profile-avatar">{{ (usuario.nombres|default('')|first)|upper }}</div>
          </div>
          <div class="profile-name">{{ usuario.nombres }} {{ usuario.apellidos }}</div>
          <div class="profile-mail">{{ usuario.correo }}</div>
          <div class="badge">Cliente</div>
          <div class="divider"></div>
          <div class="list">
            <div class="li">Teléfono: {{ usuario.telefono }}</div>
            <div class="li">Dirección: {{ usuario.direccion or 'No especificada' }}</div>
          </div>
        </section>

        <section class="card stats">
          <h3 class="card-title">Estadísticas</h3>
          <div class="row">
            <div class="key">Total de Reservas</div>
            <div class="val">{{ usuario.total_reservas or 0 }}</div>
          </div>
        </section>
      </div>

      <!-- Columna Derecha -->
      <div>
        <section class="card">
          <div class="form-head">
            <div>
              <h3 class="card-title">Información Personal</h3>
              <p class="form-sub">Actualiza tus datos personales</p>
            </div>
            <button id="btnEdit" class="btn btn-ghost" type="button">Editar</button>
          </div>

          <form id="profileForm" method="POST" action="{{ url_for('perfil.ver_perfil') }}">
            <div class="grid-form">
              <div class="field">
                <label for="nombres">Nombre</label>
                <input id="nombres" name="nombres" type="text" value="{{ usuario.nombres }}" disabled>
              </div>

              <div class="field">
                <label for="apellidos">Apellido</label>
                <input id="apellidos" name="apellidos" type="text" value="{{ usuario.apellidos }}" disabled>
              </div>

              <div class="field" style="grid-column:1 / -1">
                <label for="telefono">Teléfono</label>
                <input id="telefono" name="telefono" type="text" value="{{ usuario.telefono }}" disabled>
              </div>

              <div class="field" style="grid-column:1 / -1">
                <label for="direccion">Dirección</label>
                <input id="direccion" name="direccion" type="text" value="{{ usuario.direccion or '' }}" disabled>
              </div>
            </div>

            <div class="actions">
              <button id="btnCancel" class="btn btn-secondary" type="button" disabled>Cancelar</button>
              <button id="btnSave" class="btn btn-primary" type="submit" disabled>Guardar cambios</button>
            </div>
          </form>
        </section>

        <section class="card">
          <h3 class="card-title">Preferencias de notificación</h3>
          <p class="card-sub">Configura cómo quieres recibir actualizaciones</p>
          <div class="pref"><div><strong>Ofertas y Promociones</strong><p>Recibe ofertas especiales por email</p></div><input type="checkbox" checked></div>
          <div class="divider"></div>
          <div class="pref"><div><strong>Recordatorios de Reserva</strong><p>Notificaciones sobre tus reservas</p></div><input type="checkbox" checked></div>
        </section>
      </div>
    </div>
  </div>
</section>

<!-- Modal de confirmación -->
<div class="modal-overlay" id="modalSuccess" aria-hidden="true" role="dialog">
  <div class="modal-success" role="document">
    <div class="checkmark">
      <svg viewBox="0 0 52 52" width="52" height="52">
        <path d="M14 27 l7 7 l17 -17" />
      </svg>
    </div>
    <h2 id="modalSuccessTitle">¡Perfil actualizado!</h2>
    <p id="modalSuccessMessage">Tus datos han sido guardados correctamente.</p>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  // --- Modal de éxito ---
  const successDiv = document.getElementById("successMessage");
  if (successDiv) {
    const modal = document.getElementById("modalSuccess");
    const msg = successDiv.dataset.message;
    if (msg) document.getElementById("modalSuccessTitle").textContent = msg;
    modal.classList.add("open");
    setTimeout(() => modal.classList.remove("open"), 1500);
  }

  // --- Lógica de edición ---
  const form = document.getElementById('profileForm');
  const btnEdit = document.getElementById('btnEdit');
  const btnSave = document.getElementById('btnSave');
  const btnCancel = document.getElementById('btnCancel');
  const inputs = form.querySelectorAll('input[name]');

  function toggleForm(editable) {
    inputs.forEach(input => {
      input.disabled = !editable;
    });
    btnSave.disabled = !editable;
    btnCancel.disabled = !editable;
  }

  btnEdit.addEventListener('click', () => {
    toggleForm(true);
    form.querySelector('input[name="nombres"]').focus();
  });

  btnCancel.addEventListener('click', () => {
    form.reset();
    toggleForm(false);
  });
});
</script>
{% endblock %}
