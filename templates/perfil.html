{% extends "base.html" %}

{% block title %}Mi Perfil - Hotel San Eduardo{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/perfil.css') }}">
{% endblock %}

{% block content %}
<section class="profile-section">
  <div class="container">
    <h1 class="page-title">Mi Perfil</h1>
    <p class="page-sub">Gestiona tu informaci贸n personal y preferencias</p>

    <!-- Mensajes Flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          {% if category == 'success' %}
            <div id="successMessage" data-message="{{ message }}"></div>
          {% else %}
            <div class="alert alert-{{ category }}">{{ message }}</div>
          {% endif %}
        {% endfor %}
      {% endif %}
    {% endwith %}
    
    <div class="grid">
      <!-- Columna Izquierda -->
      <div>
        <section class="card">
          <div class="avatar">
            <div class="profile-avatar">{{ (usuario.nombres|default('')|first)|upper }}</div>
          </div>
          <div class="profile-name">{{ usuario.nombres }} {{ usuario.apellidos }}</div>
          <div class="profile-mail">{{ usuario.correo }}</div>
          <div class="badge">Cliente</div>
          <div class="divider"></div>
          <div class="list">
            <div class="li"> {{ usuario.correo }}</div>
            <div class="li"> {{ usuario.telefono }}</div>
            <div class="li"> {{ usuario.direccion or 'No especificada' }}</div>
          </div>
        </section>

        <section class="card stats">
          <h3 class="card-title">Estad铆sticas</h3>
          <div class="row"><div class="key">Total de Reservas</div><div class="val">5</div></div>
          <div class="divider"></div>
          <div class="row"><div class="key">Puntos Acumulados</div><div class="val big">250</div></div>
        </section>
      </div>

      <!-- Columna Derecha -->
      <div>
        <section class="card">
          <div class="form-head">
            <div><h3 class="card-title">Informaci贸n Personal</h3><p class="form-sub">Actualiza tus datos personales</p></div>
            <button id="btnEdit" class="btn btn-ghost" type="button">锔 Editar</button>
          </div>
          <form id="profileForm" method="POST" action="{{ url_for('perfil.ver_perfil') }}">
            <div class="grid-form">
              <div class="field"><label for="nombres">Nombre</label><input id="nombres" name="nombres" type="text" value="{{ usuario.nombres }}" disabled></div>
              <div class="field"><label for="apellidos">Apellido</label><input id="apellidos" name="apellidos" type="text" value="{{ usuario.apellidos }}" disabled></div>
              <div class="field" style="grid-column:1 / -1"><label for="correo">Correo Electr贸nico</label><input id="correo" type="email" value="{{ usuario.correo }}" readonly title="El correo no se puede modificar."></div>
              <div class="field" style="grid-column:1 / -1"><label for="telefono">Tel茅fono</label><input id="telefono" name="telefono" type="text" value="{{ usuario.telefono }}" disabled></div>
              <div class="field" style="grid-column:1 / -1"><label for="direccion">Direcci贸n</label><input id="direccion" name="direccion" type="text" value="{{ usuario.direccion or '' }}" disabled></div>
            </div>
            <div class="actions">
              <button id="btnCancel" class="btn btn-secondary" type="button" disabled>Cancelar</button>
              <button id="btnSave" class="btn btn-primary" type="submit" disabled>Guardar Cambios</button>
            </div>
          </form>
        </section>

        <section class="card">
          <h3 class="card-title">Preferencias de Notificaci贸n</h3>
          <p class="card-sub">Configura c贸mo quieres recibir actualizaciones</p>
          <div class="pref"><div><strong>Ofertas y Promociones</strong><p>Recibe ofertas especiales por email</p></div><input type="checkbox" checked></div>
          <div class="divider"></div>
          <div class="pref"><div><strong>Recordatorios de Reserva</strong><p>Notificaciones sobre tus reservas</p></div><input type="checkbox" checked></div>
        </section>
      </div>
    </div>
  </div>
</section>

<!-- Modal de confirmaci贸n -->
<div class="modal-overlay" id="modalSuccess" aria-hidden="true" role="dialog" aria-labelledby="modalSuccessTitle" aria-describedby="modalSuccessMessage">
  <div class="modal-success" role="document" tabindex="-1">
    <div class="checkmark" aria-hidden="true">
      <svg viewBox="0 0 52 52" width="52" height="52" focusable="false">
        <path d="M14 27 l7 7 l17 -17" />
      </svg>
    </div>
    <h2 id="modalSuccessTitle">隆Perfil actualizado!</h2>
    <p id="modalSuccessMessage">Tus datos han sido guardados correctamente.</p>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  // --- L贸gica para el modal de 茅xito ---
  const successDiv = document.getElementById("successMessage");
  if (successDiv) {
    const modal = document.getElementById("modalSuccess");
    const title = document.getElementById("modalSuccessTitle");
    const msg = successDiv.dataset.message;
    if (title && msg) title.textContent = msg;

    modal.classList.add("open");
    modal.setAttribute("aria-hidden", "false");

    setTimeout(() => {
      modal.classList.remove("open");
      modal.setAttribute("aria-hidden", "true");
    }, 1000);
  }

  // --- L贸gica para editar/guardar/cancelar el formulario ---
  const form = document.getElementById('profileForm');
  const btnEdit = document.getElementById('btnEdit');
  const btnSave = document.getElementById('btnSave');
  const btnCancel = document.getElementById('btnCancel');
  const inputs = form.querySelectorAll('input[name]');

  function toggleForm(editable) {
    inputs.forEach(input => {
      if (!input.readOnly) { // No habilitar campos como email o DNI
        input.disabled = !editable;
      }
    });
    btnSave.disabled = !editable;
    btnCancel.disabled = !editable;
  }

  btnEdit.addEventListener('click', () => {
    toggleForm(true);
    form.querySelector('input[name="nombres"]').focus();
  });

  btnCancel.addEventListener('click', () => {
    form.reset(); // Restaura los valores originales del HTML
    toggleForm(false);
  });
});
</script>
{% endblock %}
