{% extends "base.html" %}
{% block title %}Habitaciones Disponibles - Hotel San Eduardo{% endblock %}

{% block content %}
<div class="layout-rooms">
  <!-- Lado izquierdo: filtros -->
  <aside class="panel filtros">
    <h2>Buscar</h2>
    <form method="GET" action="{{ request.path }}">
      <label>Fecha de entrada</label>
      <input type="date" name="fecha_entrada" value="{{ fecha_entrada or '' }}">

      <label>Fecha de salida</label>
      <input type="date" name="fecha_salida" value="{{ fecha_salida or '' }}">

      <label>Tipo de habitaci√≥n</label>
      <select name="tipo">
        <option value="">Todas</option>
        {% for t in tipos_unicos %}
          <option value="{{ t.nombre }}" {% if t.nombre == (tipo or '') %}selected{% endif %}>{{ t.nombre }}</option>
        {% endfor %}
      </select>

      <label>Hu√©spedes</label>
      <input type="number" name="huespedes" min="1" value="{{ huespedes or 1 }}">

      <button type="submit" class="btn-buscar">Buscar</button>
      <button type="button" class="btn-limpiar" onclick="eliminarFiltros()">Eliminar filtros</button>

    </form>
  </aside>

  <!-- Centro: listado -->
  <section class="listado">
    {% if habitaciones %}
      {% for h in habitaciones %}
      <article class="card fade-in">
        <!-- Carrusel embebido (corregido) -->
        <div class="carousel-mini" data-room="{{ h.id_habitacion }}" data-index="0">
          <button class="carousel-btn prev">‚ùÆ</button>
          <div class="carousel-track">
            {% for img in h.galeria %}
            <div class="carousel-item">
              <img src="{{ url_for('static', filename=img) }}"
                  alt="Foto {{ loop.index }} de {{ h.tipo }}"
                  class="carousel-img"
                  onclick="abrirLightbox({{ h.id_habitacion }}, {{ loop.index0 }})"
                  onerror="this.onerror=null;this.src='{{ url_for('static', filename='img/habitaciones/img1.jpg') }}';">
            </div>
            {% endfor %}
          </div>
          <button class="carousel-btn next">‚ùØ</button>
        </div>

        <div class="card-body">
          <div class="card-head">
            <h3>{{ h.tipo }} N¬∫ {{ h.numero }}</h3>
            <div class="price">
              <span class="currency">S/</span>
              <span class="amount">{{ '%.0f'|format(h.precio_base) }}</span>
              <small>por noche</small>
            </div>
          </div>

          <p class="desc">{{ h.descripcion }}</p>
          <div class="meta"><span>üë• {{ h.capacidad }} personas</span></div>

          {% if h.comodidades %}
          <div class="chips">
            {% for c in h.comodidades %}
              <span class="chip">{{ c }}</span>
            {% endfor %}
          </div>
          {% endif %}

          <div class="actions">
            <button class="btn-primary"
                    onclick="seleccionarHabitacion('{{ h.tipo }}','{{ h.numero }}', {{ h.precio_base }}, {{ h.id_habitacion }})">
              Seleccionar
            </button>

            <button class="btn-outline" title="Ver calendario"
                    onclick="abrirCalendario({{ h.id_habitacion }})">
              Fechas disponibles
            </button>
          </div>

        </div>
      </article>
      {% endfor %}
    {% else %}
      <p class="empty">No hay habitaciones disponibles con los criterios seleccionados.</p>
    {% endif %}
  </section>

  <!-- Derecha: Tu Reserva -->
  <aside class="panel resumen">
    <h2>Tu Reserva</h2>
    <div id="resumenContenido">
      <p>No has seleccionado ninguna habitaci√≥n.</p>
    </div>
    <button class="btn-accion pago" id="btnContinuar" onclick="continuarPago()" disabled>Continuar reserva</button>
  </aside>

  <!-- Contenedor de notificaciones -->
  <div id="notificacion-container"></div>
</div>

<!-- Lightbox global -->
<div id="lightbox" class="lightbox">
  <span class="close-lightbox" onclick="cerrarLightbox()">&times;</span>
  <button class="nav-light prev" onclick="navegarLightbox(-1)">&#10094;</button>
  <img id="lightbox-img" src="" alt="Vista ampliada" />
  <button class="nav-light next" onclick="navegarLightbox(1)">&#10095;</button>
</div>

<!-- Modal Servicios Adicionales -->
<div id="modal-servicios" class="modal">
  <div class="modal-content">
    <span class="close" data-close>&times;</span>
    <h3>Servicios Adicionales</h3>
    {% if servicios %}
      <form id="formServicios">
        <div class="servicios-list">
          {% for s in servicios %}
          <div class="serv-item">
            <label>
              <input type="checkbox" name="srv" value="{{ s.id_servicio }}" data-precio="{{ '%.2f'|format(s.precio) }}">
              <strong>{{ s.nombre }}</strong>
              <small>S/. {{ '%.2f'|format(s.precio) }}</small>
            </label>
            <input type="number" class="qty" name="qty_{{ s.id_servicio }}" value="0" min="0" disabled>
          </div>
          {% endfor %}
        </div>
      </form>
      <div class="modal-actions">
        <button class="btn-primary" id="aplicarServicios">Aplicar</button>
      </div>
    {% else %}
      <p>No hay servicios disponibles por ahora.</p>
    {% endif %}
  </div>
</div>

<!-- Modal de advertencia (sin sesi√≥n) -->
<div id="modal-login" class="modal-alert">
  <div class="modal-content-alert">
    <p>Debes iniciar sesi√≥n para poder realizar reservas.</p>
  </div>
</div>

<!-- Modal del calendario -->
<div id="modal-calendario" class="modal">
  <div class="modal-content calendario-modal">
    <span class="close" onclick="cerrarCalendario()">&times;</span>
    <h3>Disponibilidad de la habitaci√≥n</h3>
    <div class="calendar-nav">
      <button onclick="cambiarMes(-1)">‚óÄ</button>
      <span id="tituloMes"></span>
      <button onclick="cambiarMes(1)">‚ñ∂</button>
    </div>
    <div id="calendarContainer"></div>
  </div>
</div>
{% endblock %}



{% block extra_css %}
<style>

.calendario-modal {
  width: 420px;
  text-align: center;
}
.calendar-nav {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 8px;
  margin-bottom: 6px;
}
.calendar-nav button {
  background: #0d6efd;
  border: none;
  color: #fff;
  padding: 5px 10px;
  border-radius: 6px;
  cursor: pointer;
}
.calendar-nav button:hover {
  background: #0b5ed7;
}
#tituloMes {
  font-weight: bold;
  color: #0f2a63;
}
#calendarContainer {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 4px;
  margin-top: 10px;
}
.dia-header {
  font-weight: bold;
  background: #e5e7eb;
  border-radius: 6px;
}
.dia {
  padding: 8px;
  border-radius: 6px;
  cursor: default;
}
.dia.ocupado {
  background: #ef4444;
  color: white;
}
.dia.libre {
  background: #d1fae5;
  color: #065f46;
}


  .btn-limpiar {
  margin-top: 8px;
  width: 100%;
  background: #e5e7eb;
  color: #374151;
  border: none;
  padding: 10px;
  border-radius: 10px;
  font-weight: 700;
  cursor: pointer;
  transition: background .2s ease;
}
.btn-limpiar:hover { background: #d1d5db; }
/* ====== Layout general ====== */
.layout-rooms {
  display: grid;
  grid-template-columns: 280px 1fr 320px;
  gap: 24px;
  padding: 90px 40px 40px;
  background: #f6f9ff;
  min-height: 100vh;
}

/* ===== Paneles laterales ===== */
.panel {
  background: #fff;
  border-radius: 14px;
  box-shadow: 0 2px 10px rgba(16, 24, 40, .06);
  padding: 18px;
  height: fit-content;
  position: sticky;
  top: 84px;
}

/* ===== Filtros ===== */
.filtros h2 { margin-bottom: 8px; color:#0f2a63; }
.filtros label { display:block; font-weight:600; margin-top:10px; }
.filtros input, .filtros select {
  width: 100%;
  padding: 9px 10px;
  margin-top: 4px;
  border: 1px solid #d5e0ff;
  border-radius: 8px;
  font-family: inherit;
  font-size: 15px;
}
.btn-buscar {
  margin-top: 14px;
  width: 100%;
  background:#0d6efd;
  color:#fff;
  border:none;
  padding:10px;
  border-radius:10px;
  font-weight:700;
  cursor:pointer;
  transition: background .2s ease;
}
.btn-buscar:hover { background:#0b5ed7; }

/* ===== Centro con scroll ===== */
.listado {
  max-height: calc(100vh - 140px);
  overflow-y: auto;
  padding-right: 8px;
}
.listado::-webkit-scrollbar { width: 8px; }
.listado::-webkit-scrollbar-thumb { background: #0d6efd; border-radius: 6px; }

/* ===== Card de habitaci√≥n ===== */
.card {
  display:flex;
  gap:18px;
  align-items: stretch;
  background:#fff;
  border-radius:14px;
  padding:12px;
  box-shadow: 0 2px 8px rgba(16,24,40,.06);
  margin-bottom: 18px;
  transition: box-shadow .2s ease;
}
.card:hover { box-shadow:0 6px 16px rgba(16,24,40,.1); }

.card-body { flex: 1; display:flex; flex-direction:column; }
.card-head {
  display:flex;
  justify-content:space-between;
  align-items:baseline;
  gap:12px;
}
.card-head h3 { margin:0; color:#0f2a63; }
.price { text-align:right; min-width: 150px; }
.price .currency { font-size: 18px; color:#0f2a63; }
.price .amount { font-size: 34px; font-weight:800; color:#0f2a63; }
.price small { display:block; color:#6b7280; }

.desc { color:#4b5563; margin:6px 0 10px; }
.meta { color:#111827; margin-bottom:8px; }

/* ===== Chips de comodidades ===== */
.chips { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:8px; }
.chip {
  padding:5px 10px;
  border-radius:9999px;
  background:#eef2ff;
  color:#3442b9;
  border:1px solid #d4d9ff;
  font-size:12px;
  font-weight:600;
}

/* ===== Botones ===== */
.actions { display:flex; gap:12px; margin-top:auto; }
.btn-outline, .btn-primary {
  padding:10px 14px;
  border-radius:10px;
  font-weight:700;
  cursor:pointer;
  border:none;
  transition: all .2s ease;
}
.btn-outline {
  background:#ecf2ff;
  color:#0f2a63;
  border:1px solid #d5e0ff;
}
.btn-outline:hover { background:#dfe8ff; }
.btn-primary { background:#0d6efd; color:#fff; }
.btn-primary:hover { background:#0b5ed7; }

/* ===== Carrusel embebido ===== */
/* ===== Carrusel embebido ===== */
.carousel-mini {
  position: relative;
  width: 320px;
  height: 200px;
  overflow: hidden;
  border-radius: 10px;
  background: #fff;
  box-shadow: 0 2px 10px rgba(0,0,0,0.08);
}

.carousel-track {
  display: flex;
  width: 100%;
  height: 100%;
  transition: transform 0.5s ease-in-out;
}

.carousel-item {
  flex: 0 0 100%;
  width: 100%;
  height: 100%;
}

.carousel-img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 10px;
  cursor: zoom-in;
}

/* Botones del carrusel */
.carousel-btn {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background: rgba(0, 0, 0, 0.45);
  color: #fff;
  border: none;
  border-radius: 50%;
  width: 34px;
  height: 34px;
  font-size: 22px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: background 0.2s ease;
  z-index: 10;
}
.carousel-btn:hover {
  background: rgba(0, 0, 0, 0.7);
}
.carousel-btn.prev {
  left: 8px;
}
.carousel-btn.next {
  right: 8px;
}
/* ===== Lightbox (ampliaci√≥n) ===== */
.lightbox {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.9);
  z-index: 9999;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  animation: fadein .3s ease;
}
.lightbox.show { display: flex; }
.lightbox img {
  max-width: 90vw;
  max-height: 80vh;
  border-radius: 10px;
  box-shadow: 0 0 20px rgba(255,255,255,0.3);
  transition: transform 0.3s ease;
}
.lightbox img:hover { transform: scale(1.02); }
.close-lightbox {
  position: absolute;
  top: 20px;
  right: 30px;
  font-size: 40px;
  color: white;
  cursor: pointer;
  z-index: 10001;
  transition: 0.2s;
}
.close-lightbox:hover { color: #f87171; }
.nav-light {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background: rgba(255,255,255,0.2);
  color: white;
  border: none;
  font-size: 40px;
  cursor: pointer;
  padding: 8px 14px;
  border-radius: 50%;
  transition: 0.2s;
}
.nav-light:hover { background: rgba(255,255,255,0.35); }
.nav-light.prev { left: 40px; }
.nav-light.next { right: 40px; }

/* ===== Resumen lateral ===== */
.resumen h2 { color:#0f2a63; margin-bottom:10px; }
#resumenContenido p { margin:6px 0; }
.btn-accion {
  width: 100%;
  margin-top:10px;
  padding:10px;
  border:none;
  border-radius:10px;
  font-weight:800;
  cursor:pointer;
  transition: background .2s ease;
}
.btn-accion.serv { background:#f0ad4e; color:#fff; }
.btn-accion.serv:hover { background:#ea9a2b; }
.btn-accion.pago { background:#28a745; color:#fff; }
.btn-accion.pago:hover { background:#218838; }
.btn-accion:disabled {
  background: #adb5bd;
  color: #f8f9fa;
  cursor: not-allowed;
}

/* ===== Modal de servicios ===== */
.modal {
  display:none;
  position: fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  z-index:1000;
  place-items: center;
  padding:16px;
}
.modal.show { display:grid; }
.modal-content {
  background:#fff;
  border-radius:14px;
  padding:18px;
  width:min(900px, 96vw);
  max-height: 92vh;
  overflow:auto;
  position:relative;
  box-shadow: 0 8px 22px rgba(16,24,40,.25);
}
.close {
  position:absolute;
  right:14px;
  top:8px;
  font-size:26px;
  cursor:pointer;
}
.servicios-list {
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px;
}
.serv-item {
  display:flex;
  justify-content:space-between;
  align-items:center;
  border:1px solid #e5e7eb;
  border-radius:10px;
  padding:10px;
}
.serv-item label { display:flex; gap:10px; align-items:center; }
.serv-item .qty {
  width:70px;
  padding:6px;
  border:1px solid #d1d5db;
  border-radius:8px;
}
.modal-actions {
  display:flex;
  justify-content:flex-end;
  margin-top:10px;
}

/* ===== Toast ===== */
#notificacion-container {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 1001;
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.notificacion-toast {
  background-color: #28a745;
  color: white;
  padding: 16px 24px;
  border-radius: 10px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  display: flex;
  align-items: center;
  gap: 12px;
  opacity: 0;
  transform: translateX(100%);
  animation: toast-in 0.5s forwards;
}
.notificacion-toast.out { animation: toast-out 0.5s forwards; }
@keyframes toast-in { to { opacity: 1; transform: translateX(0); } }
@keyframes toast-out { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(100%); } }

/* ===== Modal alerta (sin sesi√≥n) ===== */
.modal-alert {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.55);
  justify-content: center;
  align-items: center;
  z-index: 9999;
  animation: fadein .3s ease;
}
.modal-content-alert {
  background: #ffeaea;
  color: #b91c1c;
  padding: 20px 28px;
  border-radius: 14px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.25);
  font-weight: 600;
  text-align: center;
  min-width: 320px;
  border: 2px solid #fca5a5;
}

/* ===== Animaciones ===== */
.fade-in { animation:fade .25s ease; }
@keyframes fade { from { opacity:0; transform:translateY(8px);} to{opacity:1; transform:translateY(0);} }
@keyframes fadein { from { opacity: 0; } to { opacity: 1; } }

/* ===== Scroll interno en el panel derecho ===== */
.panel.resumen {
  display: flex;
  flex-direction: column;
  max-height: calc(100vh - 140px);
  overflow: hidden;
}
#resumenContenido {
  flex: 1;
  overflow-y: auto;
  padding-right: 6px;
}
#resumenContenido::-webkit-scrollbar { width: 8px; }
#resumenContenido::-webkit-scrollbar-thumb { background: #0d6efd; border-radius: 6px; }

.empty { color:#6b7280; }
</style>
{% endblock %}


{% block extra_js %}
<script>
// ======================================
// üîπ VARIABLES GLOBALES
// ======================================
const TODOS_LOS_SERVICIOS = JSON.parse('{{ servicios_json|default("[]")|safe }}');
let reservas = [];
const posiciones = {};
let lightboxImgs = [];
let lightboxIndex = 0;


// ======================================
// üìÖ VALIDACI√ìN + LIMPIEZA DE FECHAS
// ======================================
window.onload = () => {
  const fechaEntradaInput = document.querySelector('[name="fecha_entrada"]');
  const fechaSalidaInput = document.querySelector('[name="fecha_salida"]');
  const tipoSelect = document.querySelector('[name="tipo"]');
  const huespedesInput = document.querySelector('[name="huespedes"]');

  // üîπ Fecha actual sin hora
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const todayStr = today.toISOString().split("T")[0];

  // üîπ Bloquear d√≠as anteriores a hoy
  fechaEntradaInput.min = todayStr;
  fechaSalidaInput.min = todayStr;

  const form = document.querySelector(".filtros form");
if (form) {
  form.addEventListener("submit", () => {
    guardarFiltros();
  });
}

// ======================================
// üî• Recuperar filtros previos, corrigiendo comparaci√≥n de fechas
// ======================================
const filtrosPrevios = JSON.parse(localStorage.getItem("filtrosReserva") || "{}");

// Normalizar a formato YYYY-MM-DD sin zonas
function normalizarFecha(fechaStr) {
  if (!fechaStr) return "";
  const [y, m, d] = fechaStr.split("-").map(Number);
  return new Date(y, m - 1, d);
}

if (filtrosPrevios.fecha_entrada) {
  const fe = normalizarFecha(filtrosPrevios.fecha_entrada);
  if (fe.getTime() >= today.getTime()) {
    fechaEntradaInput.value = filtrosPrevios.fecha_entrada;
  } else {
    fechaEntradaInput.value = "";
  }
}

if (filtrosPrevios.fecha_salida) {
  const fs = normalizarFecha(filtrosPrevios.fecha_salida);
  if (fs.getTime() >= today.getTime()) {
    fechaSalidaInput.value = filtrosPrevios.fecha_salida;
  } else {
    fechaSalidaInput.value = "";
  }
}

if (filtrosPrevios.tipo) tipoSelect.value = filtrosPrevios.tipo;
if (filtrosPrevios.huespedes) huespedesInput.value = filtrosPrevios.huespedes;


  // ======================================
  // üîß VALIDAR FECHA DE ENTRADA
  // ======================================
  fechaEntradaInput.addEventListener("change", () => {
    const entrada = new Date(fechaEntradaInput.value);

    // Evitar fecha antes de hoy
    if (entrada < today) {
      fechaEntradaInput.value = todayStr;
      return;
    }

    // Ajustar el m√≠nimo de fecha salida
    fechaSalidaInput.min = fechaEntradaInput.value;

    // Si la salida es inv√°lida ‚Üí limpiarla
    if (fechaSalidaInput.value) {
      const salida = new Date(fechaSalidaInput.value);
      if (salida < entrada) fechaSalidaInput.value = "";
    }

    guardarFiltros();
  });

  // ======================================
  // üîß VALIDAR FECHA DE SALIDA
  // ======================================
  fechaSalidaInput.addEventListener("change", () => {
    const entrada = new Date(fechaEntradaInput.value);
    const salida = new Date(fechaSalidaInput.value);

    if (salida < today) {
      fechaSalidaInput.value = todayStr;
      return;
    }

    if (salida < entrada) {
      alert("La fecha de salida debe ser igual o posterior a la fecha de entrada.");
      fechaSalidaInput.value = "";
      return;
    }

    guardarFiltros();
  });

  // üîπ Guardar filtros iniciales si ya hay valores
  guardarFiltros();

  iniciarCarruseles();
};


// ======================================
// üíæ GUARDAR FILTROS EN LOCALSTORAGE
// ======================================
function guardarFiltros() {
  const fechaEntradaInput = document.querySelector('[name="fecha_entrada"]');
  const fechaSalidaInput = document.querySelector('[name="fecha_salida"]');
  const tipoSelect = document.querySelector('[name="tipo"]');
  const huespedesInput = document.querySelector('[name="huespedes"]');

  const filtros = {
    fecha_entrada: fechaEntradaInput.value || "",
    fecha_salida: fechaSalidaInput.value || "",
    tipo: tipoSelect.value || "",
    huespedes: huespedesInput.value || ""
  };

  localStorage.setItem("filtrosReserva", JSON.stringify(filtros));
}


// ======================================
// üñºÔ∏è CARRUSEL PEQUE√ëO
// ======================================
function iniciarCarruseles() {
  document.querySelectorAll('.carousel-mini').forEach(carrusel => {
    const id = carrusel.dataset.room;
    posiciones[id] = 0;

    let interval = setInterval(() => moverCarrusel(id, 1), 3000);

    carrusel.addEventListener('mouseenter', () => clearInterval(interval));
    carrusel.addEventListener('mouseleave', () => {
      interval = setInterval(() => moverCarrusel(id, 1), 3000);
    });
  });
}

function moverCarrusel(id, dir) {
  const track = document.querySelector(`.carousel-mini[data-room="${id}"] .carousel-track`);
  const imgs = track.querySelectorAll('.carousel-img');
  const total = imgs.length;

  posiciones[id] = (posiciones[id] ?? 0) + dir;

  if (posiciones[id] < 0) posiciones[id] = total - 1;
  if (posiciones[id] >= total) posiciones[id] = 0;

  track.style.transform = `translateX(-${posiciones[id] * 320}px)`;
}


// ======================================
// üîç LIGHTBOX
// ======================================
function abrirLightbox(id, index) {
  const track = document.querySelector(`.carousel-mini[data-room="${id}"] .carousel-track`);
  lightboxImgs = Array.from(track.querySelectorAll('.carousel-img')).map(i => i.src);
  lightboxIndex = index;

  document.getElementById("lightbox-img").src = lightboxImgs[lightboxIndex];
  document.getElementById("lightbox").classList.add("show");
}

function cerrarLightbox() {
  document.getElementById("lightbox").classList.remove("show");
}

function navegarLightbox(dir) {
  if (!lightboxImgs.length) return;

  lightboxIndex += dir;
  if (lightboxIndex < 0) lightboxIndex = lightboxImgs.length - 1;
  if (lightboxIndex >= lightboxImgs.length) lightboxIndex = 0;

  document.getElementById("lightbox-img").src = lightboxImgs[lightboxIndex];
}

document.addEventListener("keydown", e => {
  const lightbox = document.getElementById("lightbox");
  if (!lightbox.classList.contains("show")) return;

  if (e.key === "Escape") cerrarLightbox();
  if (e.key === "ArrowLeft") navegarLightbox(-1);
  if (e.key === "ArrowRight") navegarLightbox(1);
});


// ======================================
// üè® SELECCIONAR HABITACI√ìN
// ======================================
function seleccionarHabitacion(tipo, numero, precio, idHabitacion) {
  const entrada = document.querySelector('[name="fecha_entrada"]').value;
  const salida  = document.querySelector('[name="fecha_salida"]').value;

  if (!entrada || !salida) {
    alert("Selecciona fechas de entrada y salida.");
    return;
  }

  const d1 = new Date(entrada);
  const d2 = new Date(salida);

  if (d2 < d1) {
    alert("La fecha de salida debe ser posterior a la entrada.");
    return;
  }

  const noches = (d2 - d1) / (1000*60*60*24);
  const cardImg = document.querySelector(`.carousel-mini[data-room="${idHabitacion}"] .carousel-img`).src;

  const nueva = {
    tipo, numero, precio, noches,
    entrada, salida,
    id_habitacion: idHabitacion,
    imagen_seleccionada: cardImg,
    servicios: []
  };

  if (!reservas.some(r => r.id_habitacion === idHabitacion)) {
    reservas.push(nueva);
  }

  renderResumen();
}


// ======================================
// üìã RENDER DE RESUMEN
// ======================================
function renderResumen() {
  const cont = document.getElementById("resumenContenido");
  const btnContinuar = document.getElementById("btnContinuar");

  if (!reservas.length) {
    cont.innerHTML = "<p>No has seleccionado ninguna habitaci√≥n.</p>";
    btnContinuar.disabled = true;
    return;
  }

  let html = "";
  let totalGlobal = 0;

  reservas.forEach(r => {
    const totalHab = r.precio * r.noches;
    const servTotal = r.servicios.reduce((a, s) => a + (s.precio * s.qty), 0);

    const totalFinal = totalHab + servTotal;
    totalGlobal += totalFinal;

    html += `
      <div class="reserva-item">
        <img src="${r.imagen_seleccionada}" style="width:100%;border-radius:8px;margin-bottom:6px;">
        <p><strong>${r.tipo} N¬∫ ${r.numero}</strong></p>
        <p>${r.entrada} ‚Üí ${r.salida} (${r.noches} noches)</p>
        <p>Precio: S/. ${r.precio.toFixed(2)}</p>
        <p>Servicios: S/. ${servTotal.toFixed(2)}</p>
        <hr>
      </div>
    `;
  });

  html += `
    <p><strong>Total General:</strong>
      <span style="color:#0f9d58;font-weight:800;font-size:1.2em;">
        S/. ${totalGlobal.toFixed(2)}
      </span>
    </p>
    <button class="btn-accion serv" onclick="abrirServicios()">Agregar servicios adicionales</button>
  `;

  cont.innerHTML = html;
  btnContinuar.disabled = false;
}


// ======================================
// üßæ SERVICIOS ADICIONALES
// ======================================
function abrirServicios() {
  document.getElementById("modal-servicios").classList.add("show");
}

document.addEventListener("change", e => {
  if (e.target.matches('#formServicios input[name="srv"]')) {
    e.target.closest(".serv-item")
            .querySelector(".qty")
            .disabled = !e.target.checked;
  }
});

const btnAplicar = document.getElementById("aplicarServicios");

if (btnAplicar) {
  btnAplicar.addEventListener("click", () => {
    const seleccionados = [];

    document.querySelectorAll('#formServicios input[name="srv"]:checked')
      .forEach(chk => {
        const row = chk.closest(".serv-item");
        const qty = parseInt(row.querySelector(".qty").value || "0");
        const precio = parseFloat(chk.dataset.precio);
        const nombre = row.querySelector("strong").textContent.trim();

        seleccionados.push({
          id: parseInt(chk.value),
          nombre, precio, qty
        });
      });

    reservas.forEach(r => r.servicios = seleccionados);

    document.getElementById("modal-servicios").classList.remove("show");
    renderResumen();
  });
}


// ======================================
// üí≥ CONTINUAR A PAGO
// ======================================
function continuarPago() {
  if (!reservas.length) {
    alert("Selecciona una habitaci√≥n primero.");
    return;
  }

  fetch("/reservas/cliente/pago_reserva", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(reservas)
  })
  .then(async res => {
    if (res.redirected && res.url.includes("iniciar-sesion")) {
      document.getElementById("modal-login").style.display = "flex";
      setTimeout(() => { window.location.href = res.url; }, 1800);
      return;
    }

    const data = await res.json();
    if (data.ok) {
      localStorage.removeItem("filtrosReserva");
      window.location.href = "/reservas/cliente/pago_reserva";
    } else {
      alert("Error al preparar la reserva.");
    }
  });
}


// ======================================
// üîî TOAST NOTIFICATIONS
// ======================================
function mostrarNotificacion(msg) {
  const cont = document.getElementById('notificacion-container');
  const div = document.createElement('div');
  div.className = 'notificacion-toast';
  div.textContent = msg;
  cont.appendChild(div);

  setTimeout(() => {
    div.classList.add('out');
    div.addEventListener('animationend', () => div.remove());
  }, 4000);
}


// ======================================
// ‚ùå CERRAR MODALES
// ======================================
document.addEventListener("click", e => {
  if (e.target.matches(".close")) {
    e.target.closest(".modal").classList.remove("show");
  }

  if (e.target.classList.contains("modal")) {
    e.target.classList.remove("show");
  }
});


// ======================================
// üé† CARRUSEL (BOTONES)
// ======================================
document.querySelectorAll(".carousel-mini").forEach(carousel => {
  const track = carousel.querySelector(".carousel-track");
  const items = carousel.querySelectorAll(".carousel-item");
  const prevBtn = carousel.querySelector(".carousel-btn.prev");
  const nextBtn = carousel.querySelector(".carousel-btn.next");
  let index = 0;

  function updateCarousel() {
    track.style.transform = `translateX(-${index * 100}%)`;
  }

  prevBtn.addEventListener("click", () => {
    index = (index - 1 + items.length) % items.length;
    updateCarousel();
  });

  nextBtn.addEventListener("click", () => {
    index = (index + 1) % items.length;
    updateCarousel();
  });
});

// ======================================
// üßπ ELIMINAR FILTROS
// ======================================
function eliminarFiltros() {
  localStorage.removeItem("filtrosReserva");

  // Limpiar los campos del formulario
  document.querySelector('[name="fecha_entrada"]').value = "";
  document.querySelector('[name="fecha_salida"]').value = "";
  document.querySelector('[name="tipo"]').value = "";
  document.querySelector('[name="huespedes"]').value = 1;

  // Recargar la p√°gina para mostrar todo sin filtros
  window.location.href = window.location.pathname;
}

// ======================================
// üìÖ CALENDARIO DE DISPONIBILIDAD
// ======================================
let mesActual = new Date().getMonth();
let anioActual = new Date().getFullYear();
let fechasGlobalOcupadas = [];

function abrirCalendario(idHabitacion) {
  const modal = document.getElementById("modal-calendario");
  const cont = document.getElementById("calendarContainer");
  modal.classList.add("show");
  cont.innerHTML = "<p>Cargando disponibilidad...</p>";

  fetch(`/reservas/cliente/habitacion/${idHabitacion}/ocupadas`)
    .then(res => res.json())
    .then(fechas => {
      console.log("üîπ Fechas recibidas del backend:", fechas);

      if (!Array.isArray(fechas) || !fechas.length) {
        cont.innerHTML = "<p>No hay fechas reservadas.</p>";
        return;
      }

      // üîπ Guardamos global
      fechasGlobalOcupadas = fechas.map(f => f.split("T")[0]); // por si llegan con hora

      // üîπ Establecer mes inicial basado en las fechas recibidas
      const primeraFecha = new Date(fechasGlobalOcupadas[0]);
      mesActual = primeraFecha.getMonth();
      anioActual = primeraFecha.getFullYear();

      renderizarCalendario();
    })
    .catch(err => {
      console.error("Error al cargar fechas:", err);
      cont.innerHTML = "<p>Error al cargar fechas.</p>";
    });
}


function renderizarCalendario() {
  const cont = document.getElementById("calendarContainer");
  const tituloMes = document.getElementById("tituloMes");
  cont.innerHTML = "";

  const meses = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio",
                 "Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
  tituloMes.textContent = `${meses[mesActual]} ${anioActual}`;

  const primerDia = new Date(anioActual, mesActual, 1);
  const ultimoDia = new Date(anioActual, mesActual + 1, 0);
  const diasMes = ultimoDia.getDate();
  const nombresDias = ["Dom","Lun","Mar","Mi√©","Jue","Vie","S√°b"];

  // Encabezado
  nombresDias.forEach(d => {
    const div = document.createElement("div");
    div.textContent = d;
    div.className = "dia-header";
    cont.appendChild(div);
  });

  // Espacios antes del primer d√≠a
  for (let i = 0; i < primerDia.getDay(); i++) {
    cont.appendChild(document.createElement("div"));
  }

  // D√≠as del mes
  for (let d = 1; d <= diasMes; d++) {
    const fechaStr = `${anioActual}-${String(mesActual + 1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    const div = document.createElement("div");
    div.textContent = d;
    div.classList.add("dia");

  if (fechasGlobalOcupadas.some(f => f.startsWith(fechaStr))) {
    div.classList.add("ocupado");
  } else {
    div.classList.add("libre");
  }

  console.log("Fecha:", fechaStr, "‚Üí", fechasGlobalOcupadas.includes(fechaStr) ? "OCUPADA" : "LIBRE");


    cont.appendChild(div);
  }
}

function cambiarMes(dir) {
  mesActual += dir;
  if (mesActual < 0) {
    mesActual = 11;
    anioActual--;
  }
  if (mesActual > 11) {
    mesActual = 0;
    anioActual++;
  }
  renderizarCalendario();
}

function cerrarCalendario() {
  document.getElementById("modal-calendario").classList.remove("show");
}


</script>
{% endblock %}

