{% extends "principal.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
  <h2 class="fw-bold text-primary mb-0">Panel Principal</h2>
  <span class="fw-semibold">Bienvenido, {{ session.get('nombre_usuario', 'Usuario') }}</span>
</div>

<!-- Tarjetas resumen -->
<div class="row g-3 mb-4">
  <div class="col-6 col-md-3">
    <div class="card shadow-sm border-0 text-center py-3 px-2 h-100 metric-card">
      <div class="text-muted small mb-1">Reservas activas</div>
      <div class="fs-3 fw-bold mb-0">{{ reservas_activas }}</div>
    </div>
  </div>

  <div class="col-6 col-md-3">
    <div class="card shadow-sm border-0 text-center py-3 px-2 h-100 metric-card">
      <div class="text-muted small mb-1">Habitaciones disponibles</div>
      <div class="fs-3 fw-bold mb-0">{{ habitaciones_disponibles }}</div>
    </div>
  </div>

  <div class="col-6 col-md-3">
    <div class="card shadow-sm border-0 text-center py-3 px-2 h-100 metric-card">
      <div class="text-muted small mb-1">Clientes registrados</div>
      <div class="fs-3 fw-bold mb-0">{{ clientes_registrados }}</div>
    </div>
  </div>

  <div class="col-6 col-md-3">
    <div class="card shadow-sm border-0 text-center py-3 px-2 h-100 metric-card">
      <div class="text-muted small mb-1">Ingresos totales (S/)</div>
      <div class="fs-3 fw-bold mb-0">{{ ingresos_totales }}</div>
    </div>
  </div>
</div>

{% if session['rol'] == 1 %}
<div class="card border-0 shadow-sm p-4 mb-4">
  <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
    <h4 class="fw-bold mb-0">EnvÃ­o de Notificaciones</h4>
    <small class="text-muted">Busca al usuario por DNI, verifica el correo y elige el tipo de mensaje.</small>
  </div>

  <form id="formCorreo" class="row g-3 align-items-end">
    <div class="col-12 col-md-3">
      <label class="form-label">DNI del usuario</label>
      <input type="text" class="form-control" id="dni" name="dni" maxlength="8" inputmode="numeric" required>
    </div>

    <div class="col-12 col-md-4">
      <label class="form-label">Correo destino</label>
      <input type="email" class="form-control" id="correo" name="correo" readonly required>
    </div>

    <div class="col-12 col-md-3">
      <label class="form-label">Tipo</label>
      <select class="form-select" id="tipo" name="tipo" required>
        <option value="confirmacion">ConfirmaciÃ³n</option>
        <option value="recordatorio">Recordatorio</option>
        <option value="cancelacion">CancelaciÃ³n</option>
      </select>
    </div>

    <div class="col-12 col-md-2 d-grid">
      <button type="submit" class="btn btn-primary">Enviar</button>
    </div>
  </form>

  <hr class="my-4">

  <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
    <span class="text-muted small">Revisa los correos enviados por rango de fechas.</span>
    <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#modalHistorial">
      Ver historial de notificaciones
    </button>
  </div>
</div>

<!-- Modal historial -->
<div class="modal fade" id="modalHistorial" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="fw-bold mb-0">Historial de Notificaciones</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3 mb-3 align-items-end">
          <div class="col-md-5">
            <label class="form-label mb-1">Desde</label>
            <input type="date" id="fdesde" class="form-control">
          </div>
          <div class="col-md-5">
            <label class="form-label mb-1">Hasta</label>
            <input type="date" id="fhasta" class="form-control">
          </div>
          <div class="col-md-2 d-grid">
            <button class="btn btn-dark" id="btnFiltrar">ðŸ”Ž Filtrar</button>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead class="table-light">
              <tr>
                <th>Usuario</th>
                <th>Tipo</th>
                <th>Correo</th>
                <th>Asunto</th>
                <th>Estado</th>
                <th>Fecha</th>
              </tr>
            </thead>
            <tbody id="tbodyHistorial"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const URL_BUSCAR = "{{ url_for('notificaciones.buscar_usuario') }}";
const URL_ENVIAR = "{{ url_for('notificaciones.enviar_correo_real') }}";
const URL_HIST   = "{{ url_for('notificaciones.historial') }}";

// 1) Buscar correo por DNI (auto al completar 8 dÃ­gitos)
const dniInput = document.getElementById('dni');
dniInput.addEventListener('input', async (e)=>{
  const dni = e.target.value.replace(/\D/g, '');
  e.target.value = dni.substr(0, 8);
  if (dni.length === 8){
    try{
      const res = await fetch(URL_BUSCAR + '?' + new URLSearchParams({dni}));
      const data = await res.json();
      document.getElementById('correo').value = data.ok ? (data.correo || '') : '';
    }catch(err){
      console.error(err);
      document.getElementById('correo').value = '';
    }
  } else {
    document.getElementById('correo').value = '';
  }
});

// 2) Enviar correo
document.getElementById('formCorreo').addEventListener('submit', async (ev)=>{
  ev.preventDefault();
  const form = ev.target;
  const fd = new FormData(form);
  try{
    const res = await fetch(URL_ENVIAR, {method:'POST', body: fd});
    const data = await res.json();
    alert(data.msg);
  }catch(err){
    console.error(err);
    alert('Error de red enviando el correo');
  }
});

// 3) Historial con rango de fechas
async function cargarHistorial(){
  const desde = document.getElementById('fdesde').value;
  const hasta = document.getElementById('fhasta').value;
  const params = new URLSearchParams();
  if (desde) params.append('desde', desde);
  if (hasta) params.append('hasta', hasta);

  try{
    const res = await fetch(URL_HIST + '?' + params.toString());
    const data = await res.json();
    const tb = document.getElementById('tbodyHistorial');
    if (!data.ok){
      tb.innerHTML = '<tr><td colspan="6">Error cargando historial</td></tr>';
      return;
    }
    tb.innerHTML = data.items.map(n => `
      <tr>
        <td>${n.nombres}</td>
        <td>${n.tipo}</td>
        <td>${n.correo_destino}</td>
        <td>${n.asunto}</td>
        <td><span class="badge ${n.estado === 'Enviado' ? 'bg-success' : 'bg-danger'}">${n.estado}</span></td>
        <td>${n.fecha_envio}</td>
      </tr>
    `).join('');
  }catch(err){
    console.error(err);
    document.getElementById('tbodyHistorial').innerHTML = '<tr><td colspan="6">Error de red</td></tr>';
  }
}

document.getElementById('btnFiltrar').addEventListener('click', cargarHistorial);

// Cargar historial cuando se abre el modal
document.getElementById('modalHistorial').addEventListener('shown.bs.modal', cargarHistorial);
</script>

{% endif %}

{% endblock %}