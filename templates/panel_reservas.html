{% extends "principal.html" %}
{% block content %}
<div class="reservas-container">
  <div class="reservas-header">
    <h1>Gesti√≥n de Reservas</h1>
    <p>Administra, visualiza y edita todas las reservas del hotel.</p>
  </div>

  <!-- KPIs -->
  <div class="kpi-grid">
    <div class="kpi-card">
      <div class="stat-label">Total Reservas</div>
      <div class="stat-value text-default">{{ kpis.total }}</div>
    </div>
    <div class="kpi-card">
      <div class="stat-label">Activas</div>
      <div class="stat-value text-success">{{ kpis.activas }}</div>
    </div>
    <div class="kpi-card">
      <div class="stat-label">Pr√≥ximas</div>
      <div class="stat-value text-warning">{{ kpis.proximas }}</div>
    </div>
  </div>

  <!-- Barra de acciones -->
  <div class="action-bar">
    <a href="#" class="btn-primary-pill" onclick="abrirModalReserva()">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
        <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z" />
      </svg>
      Nueva Reserva
    </a>

    <div class="filters">
      <button id="btnClearFilters" class="btn-secondary" type="button">Limpiar</button>
      <input type="text" id="filterSearch" placeholder="Buscar cliente o habitaci√≥n...">
      <select id="filterEstado">
        <option value="">Todos los estados</option>
        <option value="Activa">Activa</option>
        <option value="Finalizada">Finalizada</option>
        <option value="Cancelada">Cancelada</option>
        <option value="Pendiente">Pendiente</option>
      </select>
      <input type="date" id="filterDesde">
      <input type="date" id="filterHasta">
      <select id="recordsPerPage">
        <option value="5" selected>5</option>
        <option value="10">10</option>
        <option value="50">50</option>
        <option value="100">100</option>
        <option value="9999">Todos</option>
      </select>
    </div>
  </div>

  <!-- Tabla -->
  <div class="table-wrap scrollable">
    <table class="table-reservas">
      <thead>
        <tr>
          <th>Cliente</th>
          <th>Habitaci√≥n</th>
          <th>Check-in</th>
          <th>Check-out</th>
          <th>Noches</th>
          <th>Total</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        {% for r in reservas %}
        <tr>
          <td>{{ r.cliente }}</td>
          <td>{{ r.habitacion }}</td>
          <td>{{ r.fecha_entrada.strftime('%d/%m/%Y') }}</td>
          <td>{{ r.fecha_salida.strftime('%d/%m/%Y') }}</td>
          <td>{{ r.noches }}</td>
          <td>S/. {{ "%.2f"|format(r.total) if r.total else 'N/A' }}</td>
          <td><span class="badge badge--{{ r.estado|lower }}">{{ r.estado }}</span></td>
          <td>
            <button class="icon-btn edit" title="Editar">‚úèÔ∏è</button>
            <button class="icon-btn delete" title="Eliminar">üóëÔ∏è</button>
          </td>
        </tr>
        {% else %}
        <tr><td colspan="10" style="text-align:center;">No hay reservas.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- MODAL NUEVA RESERVA -->
<div class="modal fade" id="modalReserva" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content shadow-lg">
      <form id="formReserva">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title fw-semibold">Nueva Reserva</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div class="row g-3">
            <!-- üßç Cliente -->
            <div class="col-md-5">
              <label class="form-label">DNI</label>
              <div class="input-group">
                <input type="text" id="dniBuscar" class="form-control" maxlength="12">
                <button type="button" id="btnBuscarCliente" class="btn btn-outline-secondary">Buscar</button>
              </div>
            </div>

            <div id="datosCliente" class="col-12 mt-2">
              <input type="hidden" id="idCliente" name="id_cliente">
              <div id="infoCliente" class="border rounded bg-light p-2 small text-muted text-center">
                Sin cliente seleccionado
              </div>
            </div>

            <!-- üè† Habitaciones -->
            <div class="col-md-6">
              <label>Tipo de habitaci√≥n</label>
              <select id="tipoHabitacion" class="form-select"></select>
            </div>
            <div class="col-md-6">
              <label>Habitaci√≥n disponible</label>
              <select id="habitacionDisponible" class="form-select"></select>
            </div>

            <!-- üìÖ Fechas -->
            <div class="col-md-6">
              <label>Fecha entrada</label>
              <input type="date" id="fechaEntrada" class="form-control">
            </div>
            <div class="col-md-6">
              <label>Fecha salida</label>
              <input type="date" id="fechaSalida" class="form-control">
            </div>

            <!-- üë• Hu√©spedes -->
            <div class="col-md-4">
              <label>Hu√©spedes</label>
              <input type="number" id="numHuespedes" class="form-control" min="1" value="1">
            </div>

            <!-- üåô Noches -->
            <div class="col-md-4">
              <label>Noches</label>
              <input type="text" id="numNoches" class="form-control bg-light fw-semibold" readonly>
            </div>

            <!-- üí∞ Total -->
            <div class="col-md-4">
              <label>Total (S/.)</label>
              <input type="text" id="totalEstimado" class="form-control bg-light fw-bold text-success" readonly>
            </div>
          </div>
        </div>

        <div class="modal-footer d-flex justify-content-between">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary px-4 fw-semibold">Confirmar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
// ==========================
// MODAL NUEVA RESERVA
// ==========================
function abrirModalReserva() {
  const modalEl = document.getElementById('modalReserva');
  const modal = new bootstrap.Modal(modalEl);
  const form = document.getElementById("formReserva");

  if (form) form.reset();

  const inputId = document.getElementById("idCliente");
  const infoDiv = document.getElementById("infoCliente");
  const habSel = document.getElementById("habitacionDisponible");
  const nochesInput = document.getElementById("numNoches");
  const totalInput = document.getElementById("totalEstimado");

  if (inputId) inputId.value = "";
  if (infoDiv) infoDiv.innerHTML = "";
  if (habSel) habSel.innerHTML = "<option value=''>Seleccione tipo</option>";
  if (nochesInput) nochesInput.value = "";
  if (totalInput) totalInput.value = "";

  modal.show();
}

document.addEventListener("DOMContentLoaded", () => {
  // ==========================
  // REFERENCIAS
  // ==========================
  const tipoHabitacion       = document.getElementById("tipoHabitacion");
  const habitacionDisponible = document.getElementById("habitacionDisponible");
  const fechaEntrada         = document.getElementById("fechaEntrada");
  const fechaSalida          = document.getElementById("fechaSalida");
  const nochesInput          = document.getElementById("numNoches");
  const totalInput           = document.getElementById("totalEstimado");
  const numHuespedes         = document.getElementById("numHuespedes");
  const formReserva          = document.getElementById("formReserva");

  // ==========================
  // FILTROS DE LA TABLA
  // ==========================
  const filterSearch   = document.getElementById("filterSearch");
  const filterEstado   = document.getElementById("filterEstado");
  const filterDesde    = document.getElementById("filterDesde");
  const filterHasta    = document.getElementById("filterHasta");
  const recordsPerPage = document.getElementById("recordsPerPage");
  const btnClear       = document.getElementById("btnClearFilters");
  const tableBody      = document.getElementById("tableBody");

  if (tableBody) {
    const allRows = Array.from(tableBody.querySelectorAll("tr"));

    function aplicarFiltros() {
      const q        = (filterSearch?.value || "").toLowerCase().trim();
      const est      = (filterEstado?.value || "");
      const desdeVal = filterDesde?.value || "";
      const hastaVal = filterHasta?.value || "";
      const limit    = parseInt(recordsPerPage?.value || "9999", 10);

      let visibles = 0;
      allRows.forEach(row => {
        // fila "No hay reservas"
        if (row.dataset.empty === "1") {
          row.style.display = "none";
          return;
        }

        const celdas = row.querySelectorAll("td");
        if (!celdas.length) return;

        const cliente   = (celdas[0].innerText || "").toLowerCase();
        const hab       = (celdas[1].innerText || "").toLowerCase();
        const fInTxt    = (celdas[2].innerText || "").trim();
        const estadoTxt = (celdas[6].innerText || "").trim();

        let ok = true;

        // texto
        if (q && !cliente.includes(q) && !hab.includes(q)) ok = false;

        // estado
        if (ok && est && estadoTxt !== est) ok = false;

        // fechas (con formato dd/mm/yyyy en tabla)
        if (ok && (desdeVal || hastaVal)) {
          const [d, m, y] = fInTxt.split("/");
          const fechaRow = y ? new Date(`${y}-${m}-${d}T00:00:00`) : null;
          if (fechaRow) {
            if (desdeVal && fechaRow < new Date(`${desdeVal}T00:00:00`)) ok = false;
            if (hastaVal && fechaRow > new Date(`${hastaVal}T23:59:59`)) ok = false;
          }
        }

        if (ok && visibles < limit) {
          row.style.display = "";
          visibles++;
        } else {
          row.style.display = "none";
        }
      });

      // mostrar fila "No hay reservas" si nada pasa filtros
      const visibleRows = allRows.filter(r => r.style.display !== "none");
      if (!visibleRows.length) {
        let emptyRow = tableBody.querySelector("tr[data-empty='1']");
        if (!emptyRow) {
          emptyRow = document.createElement("tr");
          emptyRow.dataset.empty = "1";
          emptyRow.innerHTML = `<td colspan="10" style="text-align:center;">No hay reservas.</td>`;
          tableBody.appendChild(emptyRow);
        }
        emptyRow.style.display = "";
      } else {
        const emptyRow = tableBody.querySelector("tr[data-empty='1']");
        if (emptyRow) emptyRow.style.display = "none";
      }
    }

    // eventos filtros
    filterSearch?.addEventListener("input", aplicarFiltros);
    filterEstado?.addEventListener("change", aplicarFiltros);
    filterDesde?.addEventListener("change", aplicarFiltros);
    filterHasta?.addEventListener("change", aplicarFiltros);
    recordsPerPage?.addEventListener("change", aplicarFiltros);
    btnClear?.addEventListener("click", () => {
      if (filterSearch) filterSearch.value = "";
      if (filterEstado) filterEstado.value = "";
      if (filterDesde)  filterDesde.value  = "";
      if (filterHasta)  filterHasta.value  = "";
      if (recordsPerPage) recordsPerPage.value = "10";
      aplicarFiltros();
    });

    aplicarFiltros();
  }

  // ==========================
  // CARGAR TIPOS HABITACI√ìN
  // ==========================
  if (tipoHabitacion) {
    fetch("/api/tipos_habitacion")
      .then(r => r.json())
      .then(data => {
        tipoHabitacion.innerHTML = "<option value=''>-- Seleccione --</option>";
        data.forEach(t => {
          tipoHabitacion.innerHTML += `<option value="${t.id_tipo}">${t.nombre}</option>`;
        });
      });
  }

  // ==========================
  // BUSCAR CLIENTE POR DNI
  // ==========================
  const btnBuscarCliente = document.getElementById("btnBuscarCliente");
  if (btnBuscarCliente) {
    btnBuscarCliente.addEventListener("click", () => {
      const dni = document.getElementById("dniBuscar").value.trim();
      if (!dni) return alert("Ingrese un DNI primero.");

      fetch(`/panel/clientes/buscar?dni=${dni}`, { credentials: "include" })
        .then(r => r.json())
        .then(c => {
          const inputId = document.getElementById("idCliente");
          const infoDiv = document.getElementById("infoCliente");
          if (!inputId || !infoDiv) return;

          if (!c.id_cliente) {
            inputId.value = "";
            infoDiv.innerHTML = `
              <div class="alert alert-warning">Cliente no encontrado. Reg√≠strelo:</div>
              <input class="form-control mb-2" placeholder="Nombres" id="nuevoNombre">
              <input class="form-control mb-2" placeholder="Apellidos" id="nuevoApellidos">
              <button type="button" class="btn btn-success btn-sm" id="btnRegistrarCliente">Registrar</button>
            `;
            const btnReg = document.getElementById("btnRegistrarCliente");
            if (btnReg) {
              btnReg.onclick = () => {
                const payload = {
                  dni,
                  nombres: document.getElementById("nuevoNombre").value,
                  apellidos: document.getElementById("nuevoApellidos").value
                };
                fetch("/panel/clientes/registrar", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify(payload),
                  credentials: "include"
                }).then(() => alert("Cliente registrado con √©xito"));
              };
            }
          } else {
            inputId.value = c.id_cliente;
            infoDiv.innerHTML = `
              <div class="border rounded p-2 bg-light text-center">
                <b>${c.nombres} ${c.apellidos}</b><br>
                ${c.correo || ""} ${c.telefono ? "¬∑ " + c.telefono : ""}
              </div>`;
          }
        })
        .catch(err => {
          console.error("Error al buscar cliente:", err);
          alert("‚ö†Ô∏è No se pudo buscar el cliente. Verifique la sesi√≥n o el servidor.");
        });
    });
  }

  // ==========================
  // HABITACIONES DISPONIBLES
  // ==========================
  function cargarHabitaciones() {
    if (!tipoHabitacion || !habitacionDisponible || !fechaEntrada || !fechaSalida) return;

    const tipo   = tipoHabitacion.value;
    const entrada = fechaEntrada.value;
    const salida  = fechaSalida.value;

    if (!tipo || !entrada || !salida) return;

    fetch(`/panel/habitaciones_disponibles?tipo=${tipo}&entrada=${entrada}&salida=${salida}`)
      .then(r => r.json())
      .then(habs => {
        habitacionDisponible.innerHTML = habs.length
          ? habs.map(h =>
              `<option value="${h.id_habitacion}">
                 ${h.numero} ‚Äî ${h.tipo} (S/.${h.precio_base})
               </option>`
            ).join("")
          : "<option value=''>Sin disponibilidad</option>";
        calcularNochesYTotal(); // recalcula al cargar
      });
  }

  tipoHabitacion?.addEventListener("change", cargarHabitaciones);
  fechaEntrada?.addEventListener("change", cargarHabitaciones);
  fechaSalida?.addEventListener("change", cargarHabitaciones);

  // ==========================
  // CALCULAR NOCHES Y TOTAL
  // ==========================
  function calcularNochesYTotal() {
    if (!fechaEntrada || !fechaSalida || !habitacionDisponible || !nochesInput || !totalInput) return;

    const entrada = fechaEntrada.value;
    const salida  = fechaSalida.value;
    const option  = habitacionDisponible.selectedOptions[0];

    if (!entrada || !salida || !option) {
      nochesInput.value = "";
      totalInput.value  = "";
      return;
    }

    const fIn  = new Date(`${entrada}T00:00:00`);
    const fOut = new Date(`${salida}T00:00:00`);

    if (isNaN(fIn) || isNaN(fOut) || fOut <= fIn) {
      nochesInput.value = "";
      totalInput.value  = "";
      return;
    }

    const txt = option.textContent;
    const m   = txt.match(/S\/\.?\s?([\d.,]+)/);
    if (!m) {
      nochesInput.value = "";
      totalInput.value  = "";
      return;
    }

    const precioNoche = parseFloat(m[1].replace(",", ""));
    const diffMs = fOut - fIn;
    const noches = diffMs / (1000 * 60 * 60 * 24);

    if (noches <= 0 || isNaN(precioNoche)) {
      nochesInput.value = "";
      totalInput.value  = "";
      return;
    }

    const total = (noches * precioNoche).toFixed(2);
    nochesInput.value = noches;
    totalInput.value  = total;
  }

  habitacionDisponible?.addEventListener("change", calcularNochesYTotal);
  fechaEntrada?.addEventListener("change", calcularNochesYTotal);
  fechaSalida?.addEventListener("change", calcularNochesYTotal);

  // ==========================
  // ENVIAR FORMULARIO
  // ==========================
  if (formReserva) {
    formReserva.addEventListener("submit", async (e) => {
      e.preventDefault();

      const idCliente = document.getElementById("idCliente")?.value;
      const idHab     = habitacionDisponible?.value;
      const fIn       = fechaEntrada?.value;
      const fOut      = fechaSalida?.value;

      if (!idCliente || !idHab || !fIn || !fOut) {
        alert("Completa cliente, habitaci√≥n y fechas antes de confirmar.");
        return;
      }

        const payload = {
        id_cliente:   idCliente,
        id_habitacion:idHab,
        fecha_entrada:fIn,
        fecha_salida: fOut,
        num_huespedes: numHuespedes ? numHuespedes.value : 1,
        noches: nochesInput ? nochesInput.value : 0,
        total: totalInput ? totalInput.value : 0
        };

      console.log("Enviando reserva:", payload);

      const resp = await fetch("/panel/reservas/nueva", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams(payload)
      });

      let data = {};
      try { data = await resp.json(); } catch(_) {}

      if (!resp.ok || data.ok === false) {
        console.error("Error al crear reserva:", data);
        alert(data.error || "Error al crear la reserva.");
        return;
      }

      alert("Reserva creada correctamente");
      location.reload();
    });
  }
});
</script>


{% endblock %}
