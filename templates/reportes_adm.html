{% extends "principal.html" %}
{% block title %}Panel de Reportes{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/reportes_adm.css') }}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
    <div>
      <h1 class="fw-bold text-primary mb-0">Panel de Reportes</h1>
      <p class="text-muted mb-0">Monitoreo general — Hotel San Eduardo</p>
    </div>

    <div class="d-flex gap-2 align-items-center">
      <label for="filtroMes" class="fw-semibold text-muted mb-0">Mes:</label>
      <input type="month" id="filtroMes" class="form-control" style="max-width:180px;" value="{{ current_month or '' }}">
      <button id="btnRefrescar" class="btn btn-outline-secondary ms-2">Refrescar</button>
    </div>
  </div>

  <!-- KPIs -->
  <div class="row g-3 mb-4">
    <div class="col-sm-6 col-md-2">
      <div class="kpi card p-3 text-center">
        <small>Reservas</small>
        <h3 id="kpi_reservas">{{ kpis.total_reservas }}</h3>
      </div>
    </div>
    <div class="col-sm-6 col-md-2">
      <div class="kpi card p-3 text-center">
        <small>Clientes</small>
        <h3 id="kpi_clientes">{{ kpis.total_clientes }}</h3>
      </div>
    </div>
    <div class="col-sm-6 col-md-2">
      <div class="kpi card p-3 text-center">
        <small>Ingresos (Hospedaje)</small>
        <h3 id="kpi_ing_hosp">{{ "%.2f"|format(kpis.ingresos_hospedaje) }}</h3>
      </div>
    </div>
    <div class="col-sm-6 col-md-2">
      <div class="kpi card p-3 text-center">
        <small>Ingresos (Servicios)</small>
        <h3 id="kpi_ing_serv">{{ "%.2f"|format(kpis.ingresos_servicios) }}</h3>
      </div>
    </div>
    <div class="col-sm-12 col-md-2">
      <div class="kpi card p-3 text-center">
        <small>Ganancias Totales</small>
        <h3 id="kpi_ganancias">{{ "%.2f"|format(kpis.ganancias_totales) }}</h3>
      </div>
    </div>
  </div>

  <!-- GRID GRAFICOS -->
  <div class="grid-charts">
    <div class="card chart-card">
      <h6>Ingresos Mensuales (Hospedaje + Servicios)</h6>
      <canvas id="chart_ingresos"></canvas>
    </div>

    <div class="card chart-card">
      <h6>Reservas por Estado</h6>
      <canvas id="chart_reservas_estado"></canvas>
    </div>

    <div class="card chart-card">
      <h6>Top 8 Habitaciones por Ingresos</h6>
      <canvas id="chart_habitaciones"></canvas>
    </div>

    <div class="card chart-card">
      <h6>Uso de Servicios (cantidad / total)</h6>
      <canvas id="chart_servicios"></canvas>
    </div>

    <div class="card chart-card">
      <h6>Ingresos por Tipo de Pago</h6>
      <canvas id="chart_tipos_pago"></canvas>
    </div>

    <div class="card chart-card">
      <h6>Reservas por Día (últimos 30 días)</h6>
      <canvas id="chart_reservas_dia"></canvas>
    </div>

    <div class="card chart-card">
      <h6>Notificaciones Enviadas (últimos 30 días)</h6>
      <canvas id="chart_notificaciones"></canvas>
    </div>

    <div class="card chart-card">
      <h6>Cancelaciones por Día (últimos 30 días)</h6>
      <canvas id="chart_cancelaciones"></canvas>
    </div>

    <div class="card chart-card">
      <h6>Valoración promedio</h6>
      <canvas id="chart_valoracion"></canvas>
    </div>
  </div>

  <div class="mt-4 card p-3">
    <h6>Tabla rápida — últimas 20 facturas</h6>
    <div class="table-responsive">
      <table class="table table-sm" id="tabla_facturas">
        <thead><tr><th>#</th><th>Fecha</th><th>Total</th><th>Estado</th></tr></thead>
        <tbody>
          {% for f in ult_facturas %}
          <tr>
            <td>{{ f.id_factura }}</td>
            <td>{{ f.fecha_emision }}</td>
            <td>{{ "%.2f"|format(f.total) }}</td>
            <td>{{ f.estado }}</td>
          </tr>
          {% else %}
          <tr><td colspan="4" class="text-center text-muted">No hay facturas</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
const initialReportData = {{ report_data|tojson }};
let charts = {};

function buildBarChart(ctx, labels, datasets, opts = {}) {
  return new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets },
    options: Object.assign({
      responsive: true,
      maintainAspectRatio: false,
      scales: { y: { beginAtZero: true } }
    }, opts)
  });
}

function drawAll(data) {
  data = data || {};
  // KPIs - si faltan, fallback a ceros
  const k = (data && data.kpis) ? data.kpis : {};
  document.getElementById('kpi_reservas').textContent = (k.total_reservas ?? 0);
  document.getElementById('kpi_clientes').textContent = (k.total_clientes ?? 0);
  document.getElementById('kpi_ing_hosp').textContent = parseFloat(k.ingresos_hospedaje || 0).toFixed(2);
  document.getElementById('kpi_ing_serv').textContent = parseFloat(k.ingresos_servicios || 0).toFixed(2);
  document.getElementById('kpi_ganancias').textContent = parseFloat(k.ganancias_totales ?? ((k.ingresos_hospedaje||0) + (k.ingresos_servicios||0))).toFixed(2);

  // Helper para destruir chart si existe
  const safeDestroy = (name) => { if (charts[name]) { try { charts[name].destroy(); } catch(e){} charts[name] = null; } };

  // Ingresos Mensuales
  const labels_ing = (data.ingresos_mensuales || []).map(x => x.mes);
  const totals_ing = (data.ingresos_mensuales || []).map(x => x.total);
  safeDestroy('ingresos');
  charts.ingresos = buildBarChart(document.getElementById('chart_ingresos').getContext('2d'), labels_ing, [{ label: 'S/', data: totals_ing }]);

  // Reservas por estado
  const labels_res = (data.reservas_estado || []).map(x => x.estado);
  const values_res = (data.reservas_estado || []).map(x => x.cantidad);
  safeDestroy('reservas_estado');
  charts.reservas_estado = buildBarChart(document.getElementById('chart_reservas_estado').getContext('2d'), labels_res, [{ label: 'Reservas', data: values_res }]);

  // Top habitaciones
  const labels_hab = (data.top_habitaciones || []).map(x => x.numero);
  const values_hab = (data.top_habitaciones || []).map(x => x.total);
  safeDestroy('habitaciones');
  charts.habitaciones = buildBarChart(document.getElementById('chart_habitaciones').getContext('2d'), labels_hab, [{ label: 'S/', data: values_hab }]);

  // Servicios (cantidad y total) — doble dataset
  const labels_ser = (data.servicios || []).map(x => x.nombre);
  const cantidad_ser = (data.servicios || []).map(x => x.cantidad);
  const total_ser = (data.servicios || []).map(x => x.total);
  safeDestroy('servicios');
  charts.servicios = buildBarChart(document.getElementById('chart_servicios').getContext('2d'), labels_ser, [
    { label: 'Cantidad', data: cantidad_ser },
    { label: 'Total (S/)', data: total_ser }
  ], { scales: { y: { beginAtZero: true } } });

  // Tipos de pago
  const labels_pago = (data.ingresos_por_pago || []).map(x => x.metodo);
  const values_pago = (data.ingresos_por_pago || []).map(x => x.total);
  safeDestroy('pagos');
  charts.pagos = buildBarChart(document.getElementById('chart_tipos_pago').getContext('2d'), labels_pago, [{ label: 'S/', data: values_pago }]);

  // Reservas por dia
  const labels_rdia = (data.reservas_por_dia || []).map(x => x.fecha);
  const values_rdia = (data.reservas_por_dia || []).map(x => x.cantidad);
  safeDestroy('reservas_dia');
  charts.reservas_dia = buildBarChart(document.getElementById('chart_reservas_dia').getContext('2d'), labels_rdia, [{ label: 'Reservas', data: values_rdia }]);

  // Notificaciones por dia
  const labels_not = (data.notificaciones_por_dia || []).map(x => x.fecha);
  const values_not = (data.notificaciones_por_dia || []).map(x => x.cantidad);
  safeDestroy('notificaciones');
  charts.notificaciones = buildBarChart(document.getElementById('chart_notificaciones').getContext('2d'), labels_not, [{ label: 'Enviadas', data: values_not }]);

  // Cancelaciones por día
  const labels_can = (data.cancelaciones_por_dia || []).map(x => x.fecha);
  const values_can = (data.cancelaciones_por_dia || []).map(x => x.cantidad);
  safeDestroy('cancelaciones');
  charts.cancelaciones = buildBarChart(document.getElementById('chart_cancelaciones').getContext('2d'), labels_can, [{ label: 'Cancelaciones', data: values_can }]);

  // Valoración promedio (simple barra)
  const avg = data.valoracion_promedio ? parseFloat(data.valoracion_promedio) : 0;
  safeDestroy('valoracion');
  charts.valoracion = buildBarChart(document.getElementById('chart_valoracion').getContext('2d'), ['Promedio'], [{ label: 'Puntuación', data: [avg] }], { scales: { y: { min: 0, max: 5 } } });
}

// fetch data (POST) — /admin/reportes/data
async function fetchReportData(mes = null) {
  const body = mes ? { mes } : {};
  const res = await fetch("{{ url_for('reportes.data') }}", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });
  if (!res.ok) {
    const txt = await res.text();
    throw new Error('Server error: ' + (txt || res.status));
  }
  return res.json();
}

document.addEventListener('DOMContentLoaded', async () => {
  // draw initial (usa report_data inyectado por Jinja al cargar)
  try {
    drawAll(initialReportData);
  } catch (e) {
    console.error("Error dibujando inicial:", e);
  }

  // handlers
  document.getElementById('btnRefrescar').addEventListener('click', async () => {
    const mes = document.getElementById('filtroMes').value || null;
    try {
      const data = await fetchReportData(mes);
      if (data.error) { alert('Error: ' + data.error); return; }
      drawAll(data);
    } catch (err) {
      alert('Error: ' + err.message);
    }
  });

  document.getElementById('filtroMes').addEventListener('change', async (e) => {
    const mes = e.target.value || null;
    try {
      const data = await fetchReportData(mes);
      if (data.error) { alert('Error: ' + data.error); return; }
      drawAll(data);
    } catch (err) {
      alert('Error: ' + err.message);
    }
  });
});
</script>

{% endblock %}
