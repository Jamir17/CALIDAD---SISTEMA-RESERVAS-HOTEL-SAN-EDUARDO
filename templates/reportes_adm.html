{% extends "principal.html" %}
{% block title %}Panel de Reportes{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/reportes_adm.css') }}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="container py-4">

  <!-- ENCABEZADO -->
  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
    <div>
      <h1 class="fw-bold text-primary mb-0">Panel de Reportes</h1>
      <p class="text-muted mb-0">Monitoreo general del Hotel San Eduardo</p>
    </div>
    <div class="d-flex align-items-center gap-2">
      <label for="filtroMes" class="fw-semibold text-muted">Filtrar por mes:</label>
      <input type="month" id="filtroMes" class="form-control" style="max-width:180px;">
    </div>
  </div>

  <!-- TARJETAS KPI -->
  <div class="row g-4 mb-4">
    <div class="col-md-2 col-6">
      <div class="card shadow-sm border-0 text-center p-3">
        <h6 class="text-muted">Reservas</h6>
        <h3 class="fw-bold">{{ kpis.total_reservas }}</h3>
      </div>
    </div>
    <div class="col-md-2 col-6">
      <div class="card shadow-sm border-0 text-center p-3">
        <h6 class="text-muted">Clientes</h6>
        <h3 class="fw-bold">{{ kpis.total_clientes }}</h3>
      </div>
    </div>
    <div class="col-md-2 col-6">
      <div class="card shadow-sm border-0 text-center p-3">
        <h6 class="text-muted">Ingresos Hospedaje (S/)</h6>
        <h3 class="fw-bold text-success">{{ "%.2f"|format(kpis.ingresos_hospedaje) }}</h3>
      </div>
    </div>
    <div class="col-md-2 col-6">
      <div class="card shadow-sm border-0 text-center p-3">
        <h6 class="text-muted">Ingresos Servicios (S/)</h6>
        <h3 class="fw-bold text-info">{{ "%.2f"|format(kpis.ingresos_servicios) }}</h3>
      </div>
    </div>
    <div class="col-md-2 col-6">
      <div class="card shadow-sm border-0 text-center p-3">
        <h6 class="text-muted">Incidencias</h6>
        <h3 class="fw-bold text-danger">{{ kpis.total_incidencias }}</h3>
      </div>
    </div>
  </div>

  <!-- GRAFICOS -->
  <div class="row g-4 mb-5">
    <div class="col-md-6">
      <div class="card shadow-sm p-3">
        <h6 class="fw-bold text-primary mb-3">Ocupación por Estado</h6>
        <canvas id="graficoOcupacion" height="220"></canvas>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card shadow-sm p-3">
        <h6 class="fw-bold text-primary mb-3">Ingresos Mensuales</h6>
        <canvas id="graficoIngresos" height="220"></canvas>
      </div>
    </div>
  </div>

  <!-- FILTROS -->
  <div class="card shadow-sm p-4 mb-4">
    <div class="row g-3 align-items-end">
      <div class="col-md-3">
        <label class="form-label fw-semibold">Tipo de Reporte</label>
        <select id="tipoReporte" class="form-select">
          <option value="reservas">Reservas</option>
          <option value="facturacion">Facturación</option>
          <option value="habitaciones">Habitaciones</option>
          <option value="clientes">Clientes</option>
          <option value="incidencias">Incidencias</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label fw-semibold">Estado</label>
        <select id="estadoFiltro" class="form-select">
          <option value="">Todos</option>
          <option value="Activa">Activa</option>
          <option value="Finalizada">Finalizada</option>
          <option value="Cancelada">Cancelada</option>
          <option value="Pagado">Pagado</option>
          <option value="Pendiente">Pendiente</option>
          <option value="Resuelta">Resuelta</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label fw-semibold">Desde</label>
        <input type="date" id="fechaInicio" class="form-control">
      </div>
      <div class="col-md-2">
        <label class="form-label fw-semibold">Hasta</label>
        <input type="date" id="fechaFin" class="form-control">
      </div>
      <div class="col-md-2 text-end">
        <button id="btnFiltrar" class="btn btn-primary w-100">Filtrar</button>
      </div>
    </div>
  </div>

  <!-- TABLA DE RESULTADOS -->
  <div class="card shadow-sm p-3">
    <h6 class="fw-bold text-primary mb-3">Resultados del Reporte</h6>
    <div class="table-responsive">
      <table class="table table-striped align-middle" id="tablaReportes">
        <thead class="table-light"></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- ACTIVIDADES -->
  <div class="mt-5">
    <h5 class="fw-bold text-primary mb-3">Últimas Actividades</h5>
    <ul class="list-group">
      {% for a in ult_actividades %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <div>
          <strong>{{ a.accion }}</strong> — Habitación {{ a.habitacion or '—' }}
          <br><small class="text-muted">Estado: {{ a.nuevo_estado }}</small>
        </div>
        <small class="text-secondary">{{ a.fecha }}</small>
      </li>
      {% else %}
      <li class="list-group-item text-muted text-center">No hay actividades recientes.</li>
      {% endfor %}
    </ul>
  </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  const ocupacion = {{ ocupacion|tojson }};
  const ingresos = {{ ingresos_mensuales|tojson }};

  // === Inicialización de gráficos ===
  const ctxOcup = document.getElementById("graficoOcupacion");
  const ctxIng = document.getElementById("graficoIngresos");

  let grafOcupacion = new Chart(ctxOcup, {
    type: "pie",
    data: {
      labels: ocupacion.map(o => o.estado),
      datasets: [{
        data: ocupacion.map(o => o.cantidad),
        backgroundColor: ["#198754", "#0d6efd", "#ffc107", "#dc3545"]
      }]
    },
    options: { plugins: { legend: { position: "bottom" } } }
  });

  let grafIngresos = new Chart(ctxIng, {
    type: "bar",
    data: {
      labels: ingresos.map(i => i.mes),
      datasets: [{
        label: "Ingresos (S/)",
        data: ingresos.map(i => i.total),
        backgroundColor: "#0d6efd"
      }]
    },
    options: {
      scales: { y: { beginAtZero: true } },
      plugins: { legend: { display: false } }
    }
  });

  // === Filtro mensual dinámico ===
  document.getElementById("filtroMes").addEventListener("change", async (e) => {
    const mes = e.target.value;
    if (!mes) return;

    const res = await fetch("/admin/reportes/filtrar_mes", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ mes })
    });

    const data = await res.json();
    if (data.error) {
      alert("Error al filtrar: " + data.error);
      return;
    }

    // Actualizar gráfico de ocupación
    grafOcupacion.data.labels = data.ocupacion.map(o => o.estado);
    grafOcupacion.data.datasets[0].data = data.ocupacion.map(o => o.cantidad);
    grafOcupacion.update();

    // Actualizar gráfico de ingresos
    grafIngresos.data.labels = data.ingresos.map(i => i.categoria);
    grafIngresos.data.datasets[0].data = data.ingresos.map(i => i.total);
    grafIngresos.update();
  });

  // === Filtro general ===
  document.getElementById("btnFiltrar").addEventListener("click", async () => {
    const tipo = document.getElementById("tipoReporte").value;
    const estado = document.getElementById("estadoFiltro").value;
    const fecha_inicio = document.getElementById("fechaInicio").value;
    const fecha_fin = document.getElementById("fechaFin").value;

    const res = await fetch("/admin/reportes/filtrar", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ tipo, estado, fecha_inicio, fecha_fin })
    });

    const data = await res.json();
    const tabla = document.getElementById("tablaReportes");
    const thead = tabla.querySelector("thead");
    const tbody = tabla.querySelector("tbody");

    tbody.innerHTML = "";
    if (!data.length) {
      thead.innerHTML = "<tr><th>No se encontraron resultados</th></tr>";
      return;
    }

    const headers = Object.keys(data[0]);
    thead.innerHTML = "<tr>" + headers.map(h => `<th>${h}</th>`).join("") + "</tr>";

    data.forEach(row => {
      const tr = document.createElement("tr");
      tr.innerHTML = headers.map(h => `<td>${row[h] ?? ""}</td>`).join("");
      tbody.appendChild(tr);
    });
  });
});
</script>
{% endblock %}
